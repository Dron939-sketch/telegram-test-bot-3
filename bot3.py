import os
import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    ContextTypes,
    ConversationHandler,
)

# ========== ИМПОРТЫ ОПИСАНИЙ ==========
from suit_descriptions import SUIT_DESCRIPTIONS
from stage2_profiles import STAGE_2_PROFILES
from stage_3_results import STAGE_3_RESULTS

# ========== НАСТРОЙКИ ==========
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO
)
logger = logging.getLogger(__name__)

TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
BOT_USERNAME = "Nanotech_varik_bot"

if not TELEGRAM_BOT_TOKEN:
    raise ValueError("❌ ОШИБКА: Переменная TELEGRAM_BOT_TOKEN не установлена!")

# ========== СОСТОЯНИЯ ==========
STAGE_1 = 1
STAGE_2 = 2
STAGE_3 = 3

# ========== ЭТАП 1: ОПРЕДЕЛЕНИЕ МАСТИ (16 вопросов) ==========
STAGE_1_QUESTIONS = [
    # ВОПРОСЫ 1-8: ОСЬ X (ФОКУС)
    {
        "axis": "X",
        "text": "Когда у тебя проблема, что ты делаешь в первую очередь?",
        "options": {
            "VOVNE": "Ищу помощь у других людей",
            "VNUTR": "Разбираюсь сам, внутри себя",
            "NEUTRAL": "Зависит от ситуации"
        }
    },
    {
        "axis": "X",
        "text": "Где ты чувствуешь себя лучше?",
        "options": {
            "VOVNE": "Среди людей, в активности",
            "VNUTR": "В одиночестве, в тишине",
            "NEUTRAL": "По-разному"
        }
    },
    {
        "axis": "X",
        "text": "Откуда ты берёшь энергию?",
        "options": {
            "VOVNE": "От общения и внешних событий",
            "VNUTR": "От размышлений и внутренней работы",
            "NEUTRAL": "Из разных источников"
        }
    },
    {
        "axis": "X",
        "text": "Что для тебя важнее?",
        "options": {
            "VOVNE": "Что происходит вокруг меня",
            "VNUTR": "Что происходит внутри меня",
            "NEUTRAL": "И то, и другое"
        }
    },
    {
        "axis": "X",
        "text": "Как ты принимаешь решения?",
        "options": {
            "VOVNE": "Советуюсь с другими, смотрю на факты",
            "VNUTR": "Слушаю себя, свои ощущения",
            "NEUTRAL": "По-разному"
        }
    },
    {
        "axis": "X",
        "text": "Что тебя больше интересует?",
        "options": {
            "VOVNE": "Люди, события, действия",
            "VNUTR": "Мысли, чувства, смыслы",
            "NEUTRAL": "Всё интересно"
        }
    },
    {
        "axis": "X",
        "text": "Когда тебе плохо, ты:",
        "options": {
            "VOVNE": "Иду к людям, ищу поддержку",
            "VNUTR": "Остаюсь один, разбираюсь сам",
            "NEUTRAL": "Зависит от настроения"
        }
    },
    {
        "axis": "X",
        "text": "Что тебя больше мотивирует?",
        "options": {
            "VOVNE": "Внешние цели, результаты, признание",
            "VNUTR": "Внутренняя гармония, понимание себя",
            "NEUTRAL": "И то, и другое"
        }
    },
    
    # ВОПРОСЫ 9-16: ОСЬ Y (СТРАХ)
    {
        "axis": "Y",
        "text": "Чего ты боишься больше?",
        "options": {
            "UMOZ": "Потерять связь с людьми, остаться одному",
            "FAKT": "Потерять контроль, стабильность, ресурсы",
            "NEUTRAL": "Не знаю"
        }
    },
    {
        "axis": "Y",
        "text": "Что для тебя хуже?",
        "options": {
            "UMOZ": "Когда нет смысла, непонятно зачем",
            "FAKT": "Когда нет порядка, всё хаотично",
            "NEUTRAL": "Оба варианта плохи"
        }
    },
    {
        "axis": "Y",
        "text": "Что тебя больше тревожит?",
        "options": {
            "UMOZ": "Отношения с людьми, чувства",
            "FAKT": "Дела, результаты, деньги",
            "NEUTRAL": "Всё тревожит"
        }
    },
    {
        "axis": "Y",
        "text": "Что ты делаешь, когда тревожно?",
        "options": {
            "UMOZ": "Думаю о людях, о смысле",
            "FAKT": "Думаю о делах, о безопасности",
            "NEUTRAL": "О разном"
        }
    },
    {
        "axis": "Y",
        "text": "Что для тебя важнее?",
        "options": {
            "UMOZ": "Понимать, чувствовать, любить",
            "FAKT": "Делать, достигать, контролировать",
            "NEUTRAL": "Всё важно"
        }
    },
    {
        "axis": "Y",
        "text": "Что тебя больше пугает?",
        "options": {
            "UMOZ": "Потерять себя, смысл жизни",
            "FAKT": "Потерять всё, что имею",
            "NEUTRAL": "Оба страха есть"
        }
    },
    {
        "axis": "Y",
        "text": "О чём ты думаешь перед сном?",
        "options": {
            "UMOZ": "О людях, отношениях, чувствах",
            "FAKT": "О делах, проблемах, планах",
            "NEUTRAL": "О разном"
        }
    },
    {
        "axis": "Y",
        "text": "Что тебя больше беспокоит?",
        "options": {
            "UMOZ": "Что меня не понимают, не любят",
            "FAKT": "Что у меня не получается, нет результата",
            "NEUTRAL": "И то, и другое"
        }
    }
]

# ========== ЭТАП 2: ОПРЕДЕЛЕНИЕ КАРТЫ (18 вопросов) ==========
STAGE_2_QUESTIONS = {
    "clubs": [  # ТРЕФЫ
        {
            "text": "Как ты чувствуешь себя среди людей?",
            "options": {
                "6": "Чужим, не на своём месте",
                "7": "Ищу своих, где мне хорошо",
                "8": "Адаптируюсь, подстраиваюсь",
                "9": "Выполняю свою роль в группе"
            }
        },
        {
            "text": "Что ты делаешь, когда одиноко?",
            "options": {
                "6": "Терплю, жду, когда пройдёт",
                "7": "Активно ищу своих людей",
                "8": "Иду туда, где есть люди",
                "9": "Включаюсь в работу, дела"
            }
        },
        {
            "text": "Как ты строишь отношения?",
            "options": {
                "6": "Сложно, часто не получается",
                "7": "Ищу настоящих, близких",
                "8": "Легко знакомлюсь, общаюсь",
                "9": "Через общие дела, интересы"
            }
        },
        {
            "text": "Что для тебя «свои люди»?",
            "options": {
                "6": "Те, кто примет меня таким",
                "7": "Те, с кем я чувствую связь",
                "8": "Те, с кем выгодно",
                "9": "Коллеги, единомышленники"
            }
        },
        {
            "text": "Как ты реагируешь на отказ?",
            "options": {
                "6": "Больно, замыкаюсь",
                "7": "Ищу дальше, не сдаюсь",
                "8": "Переключаюсь на других",
                "9": "Принимаю, продолжаю работу"
            }
        },
        {
            "text": "Что ты чувствуешь в новой компании?",
            "options": {
                "6": "Тревогу, дискомфорт",
                "7": "Интерес, надежду найти своих",
                "8": "Азарт, возможности",
                "9": "Спокойствие, если понятна роль"
            }
        },
        {
            "text": "Как ты проявляешь себя?",
            "options": {
                "6": "Скромно, незаметно",
                "7": "Ярко, ищу отклик",
                "8": "Гибко, по ситуации",
                "9": "Через дела, результаты"
            }
        },
        {
            "text": "Что для тебя дружба?",
            "options": {
                "6": "Когда меня принимают",
                "7": "Глубокая связь, понимание",
                "8": "Взаимная выгода",
                "9": "Общие цели, интересы"
            }
        },
        {
            "text": "Как ты выбираешь людей?",
            "options": {
                "6": "Кто примет меня",
                "7": "Кто откликается душой",
                "8": "Кто полезен, интересен",
                "9": "Кто разделяет мои ценности"
            }
        },
        {
            "text": "Что ты делаешь для связи?",
            "options": {
                "6": "Жду, когда ко мне придут",
                "7": "Активно ищу, проявляю себя",
                "8": "Создаю возможности для встреч",
                "9": "Участвую в общих делах"
            }
        },
        {
            "text": "Как ты ведёшь себя в конфликте?",
            "options": {
                "6": "Ухожу, избегаю",
                "7": "Отстаиваю свою позицию",
                "8": "Ищу компромисс",
                "10": "Беру ответственность, решаю"
            }
        },
        {
            "text": "Что для тебя команда?",
            "options": {
                "7": "Место, где я ищу своих",
                "8": "Инструмент для целей",
                "9": "Место, где я работаю",
                "10": "То, что я создаю и веду"
            }
        },
        {
            "text": "Как ты влияешь на людей?",
            "options": {
                "8": "Через убеждение, манипуляцию",
                "9": "Через пример, дела",
                "10": "Через лидерство, вдохновение",
                "J": "Через мастерство, авторитет"
            }
        },
        {
            "text": "Что ты даёшь людям?",
            "options": {
                "9": "Надёжность, стабильность",
                "10": "Направление, цель",
                "J": "Мастерство, опыт",
                "Q": "Знания, обучение"
            }
        },
        {
            "text": "Как ты учишь других?",
            "options": {
                "J": "Показываю на своём примере",
                "Q": "Объясняю, передаю систему",
                "K": "Вдохновляю, создаю новое",
                "A": "Просто живу, другие учатся"
            }
        },
        {
            "text": "Что для тебя признание?",
            "options": {
                "10": "Когда за мной идут",
                "J": "Когда уважают моё мастерство",
                "Q": "Когда ценят мои знания",
                "K": "Когда помнят мой вклад"
            }
        },
        {
            "text": "Какова твоя роль в мире?",
            "options": {
                "J": "Мастер своего дела",
                "Q": "Учитель, наставник",
                "K": "Создатель нового",
                "A": "Свободный человек"
            }
        },
        {
            "text": "Что ты оставишь людям?",
            "options": {
                "Q": "Систему, школу",
                "K": "Новую парадигму",
                "A": "Пример свободы",
                "10": "Команду, результаты"
            }
        }
    ],
    
    "hearts": [  # ЧЕРВИ
        {
            "text": "Что ты чувствуешь в жизни?",
            "options": {
                "6": "Пустоту, бессмысленность",
                "7": "Ищу смысл, глубину",
                "8": "Играю роли, адаптируюсь",
                "9": "Выполняю свою функцию"
            }
        },
        {
            "text": "Что ты делаешь, когда пусто?",
            "options": {
                "6": "Терплю, жду",
                "7": "Ищу то, что наполнит",
                "8": "Отвлекаюсь, развлекаюсь",
                "9": "Погружаюсь в работу"
            }
        },
        {
            "text": "Как ты проживаешь чувства?",
            "options": {
                "6": "Подавляю, не показываю",
                "7": "Ищу способы выразить",
                "8": "Контролирую, использую",
                "9": "Держу в рамках"
            }
        },
        {
            "text": "Что для тебя любовь?",
            "options": {
                "6": "То, чего мне не хватает",
                "7": "То, что я ищу всю жизнь",
                "8": "Инструмент, игра",
                "9": "Часть жизни, обязанность"
            }
        },
        {
            "text": "Как ты реагируешь на боль?",
            "options": {
                "6": "Замираю, не знаю что делать",
                "7": "Иду в неё, проживаю",
                "8": "Избегаю, переключаюсь",
                "9": "Терплю, справляюсь"
            }
        },
        {
            "text": "Что ты чувствуешь в одиночестве?",
            "options": {
                "6": "Страх, тоску",
                "7": "Возможность встретить себя",
                "8": "Дискомфорт, скуку",
                "9": "Спокойствие, если есть дела"
            }
        },
        {
            "text": "Как ты ищешь смысл?",
            "options": {
                "6": "Не знаю как",
                "7": "Через переживания, опыт",
                "8": "Через разные практики",
                "9": "Через работу, служение"
            }
        },
        {
            "text": "Что для тебя глубина?",
            "options": {
                "6": "То, чего я боюсь",
                "7": "То, к чему я стремлюсь",
                "8": "То, что я изучаю",
                "9": "То, что я принимаю"
            }
        },
        {
            "text": "Как ты выражаешь себя?",
            "options": {
                "6": "Никак, молчу",
                "7": "Через искусство, творчество",
                "8": "Через разные образы",
                "9": "Через свою работу"
            }
        },
        {
            "text": "Что ты делаешь с чувствами?",
            "options": {
                "6": "Прячу, боюсь",
                "7": "Исследую, проживаю",
                "8": "Использую для целей",
                "9": "Контролирую, управляю"
            }
        },
        {
            "text": "Как ты работаешь с болью?",
            "options": {
                "6": "Избегаю, убегаю",
                "7": "Иду в неё, трансформирую",
                "8": "Анализирую, изучаю",
                "10": "Помогаю другим с их болью"
            }
        },
        {
            "text": "Что для тебя исцеление?",
            "options": {
                "7": "Встреча с собой",
                "8": "Понимание механизмов",
                "9": "Восстановление функций",
                "10": "Помощь другим"
            }
        },
        {
            "text": "Как ты влияешь на других?",
            "options": {
                "8": "Через эмоции, чувства",
                "9": "Через стабильность, надёжность",
                "10": "Через вдохновение",
                "J": "Через глубину понимания"
            }
        },
        {
            "text": "Что ты даёшь миру?",
            "options": {
                "9": "Стабильность, порядок",
                "10": "Направление, смысл",
                "J": "Глубину, мастерство",
                "Q": "Мудрость, учение"
            }
        },
        {
            "text": "Как ты учишь других чувствовать?",
            "options": {
                "J": "Через свой пример",
                "Q": "Через систему, практики",
                "K": "Через новые методы",
                "A": "Просто живу, не учу"
            }
        },
        {
            "text": "Что для тебя мудрость?",
            "options": {
                "10": "Умение вести других",
                "J": "Глубокое понимание",
                "Q": "Знание, которым делюсь",
                "K": "Создание нового понимания"
            }
        },
        {
            "text": "Какова твоя роль?",
            "options": {
                "J": "Мастер чувств",
                "Q": "Учитель смысла",
                "K": "Создатель новых смыслов",
                "A": "Свободный от смыслов"
            }
        },
        {
            "text": "Что ты оставишь миру?",
            "options": {
                "Q": "Учение о чувствах",
                "K": "Новую парадигму",
                "A": "Пример свободы",
                "10": "Исцелённых людей"
            }
        }
    ],
    
    "diamonds": [  # БУБНЫ
        {
            "text": "Что ты чувствуешь в жизни?",
            "options": {
                "6": "Нехватку, недостаток",
                "7": "Борюсь за ресурсы",
                "8": "Ищу возможности",
                "9": "Работаю, зарабатываю"
            }
        },
        {
            "text": "Что ты делаешь, когда мало денег?",
            "options": {
                "6": "Терплю, жду",
                "7": "Ищу способы заработать",
                "8": "Ищу выгодные варианты",
                "9": "Работаю больше"
            }
        },
        {
            "text": "Как ты зарабатываешь?",
            "options": {
                "6": "Как получится, нестабильно",
                "7": "Через усилия, борьбу",
                "8": "Через связи, возможности",
                "9": "Через работу, труд"
            }
        },
        {
            "text": "Что для тебя деньги?",
            "options": {
                "6": "То, чего всегда мало",
                "7": "То, за что надо бороться",
                "8": "Инструмент, возможности",
                "9": "Результат работы"
            }
        },
        {
            "text": "Как ты реагируешь на потери?",
            "options": {
                "6": "Паникую, не знаю что делать",
                "7": "Борюсь, восстанавливаю",
                "8": "Ищу новые возможности",
                "9": "Принимаю, работаю дальше"
            }
        },
        {
            "text": "Что ты чувствуешь без денег?",
            "options": {
                "6": "Страх, беспомощность",
                "7": "Злость, мотивацию",
                "8": "Азарт, вызов",
                "9": "Дискомфорт, но справлюсь"
            }
        },
        {
            "text": "Как ты ищешь ресурсы?",
            "options": {
                "6": "Не знаю как",
                "7": "Активно, настойчиво",
                "8": "Через связи, схемы",
                "9": "Через работу, навыки"
            }
        },
        {
            "text": "Что для тебя успех?",
            "options": {
                "6": "Когда хватает на жизнь",
                "7": "Когда добился своего",
                "8": "Когда выгодно и интересно",
                "9": "Когда стабильно и надёжно"
            }
        },
        {
            "text": "Как ты создаёшь результат?",
            "options": {
                "6": "Сложно, не всегда получается",
                "7": "Через усилия, борьбу",
                "8": "Через стратегию, гибкость",
                "9": "Через систему, дисциплину"
            }
        },
        {
            "text": "Что ты делаешь с ресурсами?",
            "options": {
                "6": "Трачу, не умею копить",
                "7": "Вкладываю в развитие",
                "8": "Использую для новых целей",
                "9": "Распределяю, планирую"
            }
        },
        {
            "text": "Как ты работаешь с деньгами?",
            "options": {
                "6": "Плохо, всегда проблемы",
                "7": "Зарабатываю, но нестабильно",
                "8": "Ищу выгодные схемы",
                "10": "Создаю бизнес, системы"
            }
        },
        {
            "text": "Что для тебя богатство?",
            "options": {
                "7": "Свобода от нужды",
                "8": "Возможности, влияние",
                "9": "Стабильность, безопасность",
                "10": "Результат моего дела"
            }
        },
        {
            "text": "Как ты влияешь на других?",
            "options": {
                "8": "Через выгоду, интерес",
                "9": "Через надёжность, качество",
                "10": "Через результаты, успех",
                "J": "Через мастерство, экспертизу"
            }
        },
        {
            "text": "Что ты даёшь миру?",
            "options": {
                "9": "Качественную работу",
                "10": "Результаты, проекты",
                "J": "Экспертизу, мастерство",
                "Q": "Знания, обучение"
            }
        },
        {
            "text": "Как ты учишь других зарабатывать?",
            "options": {
                "J": "Через свой пример",
                "Q": "Через систему, методы",
                "K": "Через новые подходы",
                "A": "Не учу, каждый сам"
            }
        },
        {
            "text": "Что для тебя мастерство?",
            "options": {
                "10": "Умение создавать результат",
                "J": "Высокий уровень навыков",
                "Q": "Знание, которым делюсь",
                "K": "Создание новых методов"
            }
        },
        {
            "text": "Какова твоя роль?",
            "options": {
                "J": "Мастер своего дела",
                "Q": "Учитель, эксперт",
                "K": "Создатель систем",
                "A": "Свободный от системы"
            }
        },
        {
            "text": "Что ты оставишь миру?",
            "options": {
                "Q": "Систему заработка",
                "K": "Новую экономику",
                "A": "Пример свободы от денег",
                "10": "Успешный бизнес"
            }
        }
    ],
    
    "spades": [  # ПИКИ
        {
            "text": "Что ты чувствуешь в жизни?",
            "options": {
                "6": "Хаос, непонимание",
                "7": "Борюсь за порядок",
                "8": "Ищу закономерности",
                "9": "Поддерживаю систему"
            }
        },
        {
            "text": "Что ты делаешь, когда хаос?",
            "options": {
                "6": "Теряюсь, не знаю что делать",
                "7": "Пытаюсь навести порядок",
                "8": "Ищу способы адаптироваться",
                "9": "Возвращаюсь к системе"
            }
        },
        {
            "text": "Как ты создаёшь порядок?",
            "options": {
                "6": "Не умею, всё время хаос",
                "7": "Через усилия, борьбу",
                "8": "Через гибкие системы",
                "9": "Через правила, структуру"
            }
        },
        {
            "text": "Что для тебя порядок?",
            "options": {
                "6": "То, чего мне не хватает",
                "7": "То, за что я борюсь",
                "8": "Инструмент для целей",
                "9": "Основа жизни"
            }
        },
        {
            "text": "Как ты реагируешь на хаос?",
            "options": {
                "6": "Паникую, замираю",
                "7": "Злюсь, действую",
                "8": "Ищу возможности",
                "9": "Спокойно восстанавливаю"
            }
        },
        {
            "text": "Что ты чувствуешь без контроля?",
            "options": {
                "6": "Страх, тревогу",
                "7": "Злость, мотивацию",
                "8": "Интерес, вызов",
                "9": "Дискомфорт"
            }
        },
        {
            "text": "Как ты ищешь понимание?",
            "options": {
                "6": "Не знаю как",
                "7": "Активно, настойчиво",
                "8": "Через разные источники",
                "9": "Через систему, обучение"
            }
        },
        {
            "text": "Что для тебя знание?",
            "options": {
                "6": "То, чего мне не хватает",
                "7": "То, что я ищу",
                "8": "Инструмент для целей",
                "9": "Основа работы"
            }
        },
        {
            "text": "Как ты создаёшь системы?",
            "options": {
                "6": "Не умею, всё разваливается",
                "7": "Через усилия, ошибки",
                "8": "Через эксперименты",
                "9": "Через правила, структуру"
            }
        },
        {
            "text": "Что ты делаешь со знаниями?",
            "options": {
                "6": "Не знаю, как применить",
                "7": "Использую для борьбы",
                "8": "Использую для целей",
                "9": "Систематизирую, применяю"
            }
        },
        {
            "text": "Как ты работаешь с информацией?",
            "options": {
                "6": "Теряюсь, не понимаю",
                "7": "Ищу нужное, отбрасываю лишнее",
                "8": "Ищу выгодное, полезное",
                "10": "Создаю системы знаний"
            }
        },
        {
            "text": "Что для тебя мудрость?",
            "options": {
                "7": "Понимание, как действовать",
                "8": "Знание, как достигать целей",
                "9": "Знание системы",
                "10": "Создание системы"
            }
        },
        {
            "text": "Как ты влияешь на других?",
            "options": {
                "8": "Через логику, аргументы",
                "9": "Через правила, структуру",
                "10": "Через системы, организацию",
                "J": "Через экспертизу, мастерство"
            }
        },
        {
            "text": "Что ты даёшь миру?",
            "options": {
                "9": "Порядок, стабильность",
                "10": "Системы, организацию",
                "J": "Экспертизу, мастерство",
                "Q": "Знания, обучение"
            }
        },
        {
            "text": "Как ты учишь других понимать?",
            "options": {
                "J": "Через свой пример",
                "Q": "Через систему, методы",
                "K": "Через новые подходы",
                "A": "Не учу, каждый сам"
            }
        },
        {
            "text": "Что для тебя мастерство?",
            "options": {
                "10": "Умение создавать порядок",
                "J": "Глубокое понимание",
                "Q": "Знание, которым делюсь",
                "K": "Создание новых систем"
            }
        },
        {
            "text": "Какова твоя роль?",
            "options": {
                "J": "Мастер своего дела",
                "Q": "Учитель, эксперт",
                "K": "Создатель систем",
                "A": "Свободный от систем"
            }
        },
        {
            "text": "Что ты оставишь миру?",
            "options": {
                "Q": "Систему знаний",
                "K": "Новую парадигму",
                "A": "Пример свободы",
                "10": "Организацию, структуру"
            }
        }
    ]
}

# ========== ЭТАП 3: ОПРЕДЕЛЕНИЕ ПРОБЛЕМНОГО УРОВНЯ (12 вопросов) ==========
STAGE_3_QUESTIONS = {
    "clubs": [  # ТРЕФЫ
        {
            "level": "environment",
            "text": "Где вы чувствуете себя хуже всего?",
            "options": {
                "PROBLEM": "Среди чужих людей",
                "PROBLEM_ALT": "В одиночестве",
                "OK": "Везде нормально"
            }
        },
        {
            "level": "environment",
            "text": "Что в вашем окружении не так?",
            "options": {
                "PROBLEM": "Не те люди",
                "PROBLEM_ALT": "Нет моих людей",
                "OK": "Всё нормально"
            }
        },
        {
            "level": "behavior",
            "text": "Что вы делаете, когда хотите сблизиться?",
            "options": {
                "PROBLEM": "Не знаю как",
                "PROBLEM_ALT": "Делаю, но не работает",
                "OK": "Умею хорошо"
            }
        },
        {
            "level": "behavior",
            "text": "Как вы строите отношения?",
            "options": {
                "PROBLEM": "Неправильно",
                "PROBLEM_ALT": "Не умею",
                "OK": "Хорошо"
            }
        },
        {
            "level": "capabilities",
            "text": "Вы умеете налаживать связи?",
            "options": {
                "PROBLEM": "Нет этого навыка",
                "PROBLEM_ALT": "Плохо получается",
                "OK": "Да, умею"
            }
        },
        {
            "level": "capabilities",
            "text": "Что вам мешает быть ближе с людьми?",
            "options": {
                "PROBLEM": "Не умею чувствовать других",
                "PROBLEM_ALT": "Не умею открываться",
                "OK": "Ничего не мешает"
            }
        },
        {
            "level": "values",
            "text": "Зачем вам связи с людьми?",
            "options": {
                "PROBLEM": "Не знаю зачем",
                "PROBLEM_ALT": "Не понимаю смысла",
                "OK": "Знаю зачем"
            }
        },
        {
            "level": "values",
            "text": "Что для вас важно в отношениях?",
            "options": {
                "PROBLEM": "Не понимаю что",
                "PROBLEM_ALT": "Запутался в ценностях",
                "OK": "Понимаю"
            }
        },
        {
            "level": "identity",
            "text": "Кто вы в отношениях?",
            "options": {
                "PROBLEM": "Не знаю кто",
                "PROBLEM_ALT": "Играю роль",
                "OK": "Знаю кто я"
            }
        },
        {
            "level": "identity",
            "text": "Вы чувствуете себя собой с людьми?",
            "options": {
                "PROBLEM": "Нет, я другой",
                "PROBLEM_ALT": "Не понимаю, кто я",
                "OK": "Да, я — это я"
            }
        },
        {
            "level": "mission",
            "text": "Для чего вы нужны людям?",
            "options": {
                "PROBLEM": "Не знаю для чего",
                "PROBLEM_ALT": "Не вижу смысла",
                "OK": "Знаю свою роль"
            }
        },
        {
            "level": "mission",
            "text": "Какой ваш вклад в мир через связи?",
            "options": {
                "PROBLEM": "Нет вклада",
                "PROBLEM_ALT": "Не понимаю зачем я",
                "OK": "Понимаю миссию"
            }
        }
    ],
    
    "hearts": [  # ЧЕРВИ
        {
            "level": "environment",
            "text": "Где вы чувствуете пустоту сильнее?",
            "options": {
                "PROBLEM": "В поверхностном мире",
                "PROBLEM_ALT": "В одиночестве",
                "OK": "Нигде особенно"
            }
        },
        {
            "level": "environment",
            "text": "Что не так с вашим миром?",
            "options": {
                "PROBLEM": "Вокруг нет глубины",
                "PROBLEM_ALT": "Нет смысла вокруг",
                "OK": "Всё нормально"
            }
        },
        {
            "level": "behavior",
            "text": "Что вы делаете, когда ищете смысл?",
            "options": {
                "PROBLEM": "Не знаю как искать",
                "PROBLEM_ALT": "Ищу, но не нахожу",
                "OK": "Умею искать"
            }
        },
        {
            "level": "behavior",
            "text": "Как вы работаете с чувствами?",
            "options": {
                "PROBLEM": "Неправильно",
                "PROBLEM_ALT": "Не умею",
                "OK": "Хорошо"
            }
        },
        {
            "level": "capabilities",
            "text": "Вы умеете чувствовать глубоко?",
            "options": {
                "PROBLEM": "Нет этого навыка",
                "PROBLEM_ALT": "Плохо получается",
                "OK": "Да, умею"
            }
        },
        {
            "level": "capabilities",
            "text": "Что мешает вам чувствовать?",
            "options": {
                "PROBLEM": "Не умею проживать",
                "PROBLEM_ALT": "Не умею быть в чувстве",
                "OK": "Ничего не мешает"
            }
        },
        {
            "level": "values",
            "text": "Зачем вам глубина и смысл?",
            "options": {
                "PROBLEM": "Не знаю зачем",
                "PROBLEM_ALT": "Не понимаю смысла",
                "OK": "Знаю зачем"
            }
        },
        {
            "level": "values",
            "text": "Что для вас важно в жизни?",
            "options": {
                "PROBLEM": "Не понимаю что",
                "PROBLEM_ALT": "Запутался в ценностях",
                "OK": "Понимаю"
            }
        },
        {
            "level": "identity",
            "text": "Кто вы на самом деле?",
            "options": {
                "PROBLEM": "Не знаю кто",
                "PROBLEM_ALT": "Потерял себя",
                "OK": "Знаю кто я"
            }
        },
        {
            "level": "identity",
            "text": "Вы чувствуете свою суть?",
            "options": {
                "PROBLEM": "Нет, я пустой",
                "PROBLEM_ALT": "Не понимаю, кто я",
                "OK": "Да, чувствую"
            }
        },
        {
            "level": "mission",
            "text": "Для чего вы в этом мире?",
            "options": {
                "PROBLEM": "Не знаю для чего",
                "PROBLEM_ALT": "Не вижу смысла",
                "OK": "Знаю свою миссию"
            }
        },
        {
            "level": "mission",
            "text": "Какой ваш вклад в мир через чувства?",
            "options": {
                "PROBLEM": "Нет вклада",
                "PROBLEM_ALT": "Не понимаю зачем я",
                "OK": "Понимаю миссию"
            }
        }
    ],
    
    "diamonds": [  # БУБНЫ
        {
            "level": "environment",
            "text": "Где вы чувствуете нехватку сильнее?",
            "options": {
                "PROBLEM": "В бедном окружении",
                "PROBLEM_ALT": "Везде не хватает",
                "OK": "Нигде особенно"
            }
        },
        {
            "level": "environment",
            "text": "Что не так с вашим миром?",
            "options": {
                "PROBLEM": "Мало ресурсов вокруг",
                "PROBLEM_ALT": "Нет возможностей",
                "OK": "Всё нормально"
            }
        },
        {
            "level": "behavior",
            "text": "Что вы делаете, когда нужны ресурсы?",
            "options": {
                "PROBLEM": "Не знаю как добыть",
                "PROBLEM_ALT": "Делаю, но не получается",
                "OK": "Умею добывать"
            }
        },
        {
            "level": "behavior",
            "text": "Как вы достигаете целей?",
            "options": {
                "PROBLEM": "Неправильно",
                "PROBLEM_ALT": "Не умею",
                "OK": "Хорошо"
            }
        },
        {
            "level": "capabilities",
            "text": "Вы умеете зарабатывать/создавать?",
            "options": {
                "PROBLEM": "Нет этого навыка",
                "PROBLEM_ALT": "Плохо получается",
                "OK": "Да, умею"
            }
        },
        {
            "level": "capabilities",
            "text": "Что мешает вам достигать?",
            "options": {
                "PROBLEM": "Не умею планировать",
                "PROBLEM_ALT": "Не умею действовать",
                "OK": "Ничего не мешает"
            }
        },
        {
            "level": "values",
            "text": "Зачем вам достижения?",
            "options": {
                "PROBLEM": "Не знаю зачем",
                "PROBLEM_ALT": "Не понимаю смысла",
                "OK": "Знаю зачем"
            }
        },
        {
            "level": "values",
            "text": "Что для вас важно в успехе?",
            "options": {
                "PROBLEM": "Не понимаю что",
                "PROBLEM_ALT": "Запутался в ценностях",
                "OK": "Понимаю"
            }
        },
        {
            "level": "identity",
            "text": "Кто вы в мире достижений?",
            "options": {
                "PROBLEM": "Не знаю кто",
                "PROBLEM_ALT": "Неудачник",
                "OK": "Знаю кто я"
            }
        },
        {
            "level": "identity",
            "text": "Вы чувствуете себя способным?",
            "options": {
                "PROBLEM": "Нет, я слабый",
                "PROBLEM_ALT": "Не понимаю, кто я",
                "OK": "Да, я способен"
            }
        },
        {
            "level": "mission",
            "text": "Для чего вы создаёте?",
            "options": {
                "PROBLEM": "Не знаю для чего",
                "PROBLEM_ALT": "Не вижу смысла",
                "OK": "Знаю свою миссию"
            }
        },
        {
            "level": "mission",
            "text": "Какой ваш вклад в мир через дела?",
            "options": {
                "PROBLEM": "Нет вклада",
                "PROBLEM_ALT": "Не понимаю зачем я",
                "OK": "Понимаю миссию"
            }
        }
    ],
    
    "spades": [  # ПИКИ
        {
            "level": "environment",
            "text": "Где вы чувствуете хаос сильнее?",
            "options": {
                "PROBLEM": "В беспорядочном мире",
                "PROBLEM_ALT": "Везде хаос",
                "OK": "Нигде особенно"
            }
        },
        {
            "level": "environment",
            "text": "Что не так с вашим миром?",
            "options": {
                "PROBLEM": "Вокруг нет порядка",
                "PROBLEM_ALT": "Нет логики",
                "OK": "Всё нормально"
            }
        },
        {
            "level": "behavior",
            "text": "Что вы делаете, когда нужен порядок?",
            "options": {
                "PROBLEM": "Не знаю как создать",
                "PROBLEM_ALT": "Делаю, но не получается",
                "OK": "Умею создавать"
            }
        },
        {
            "level": "behavior",
            "text": "Как вы наводите порядок?",
            "options": {
                "PROBLEM": "Неправильно",
                "PROBLEM_ALT": "Не умею",
                "OK": "Хорошо"
            }
        },
        {
            "level": "capabilities",
            "text": "Вы умеете создавать системы?",
            "options": {
                "PROBLEM": "Нет этого навыка",
                "PROBLEM_ALT": "Плохо получается",
                "OK": "Да, умею"
            }
        },
        {
            "level": "capabilities",
            "text": "Что мешает вам контролировать?",
            "options": {
                "PROBLEM": "Не умею анализировать",
                "PROBLEM_ALT": "Не умею структурировать",
                "OK": "Ничего не мешает"
            }
        },
        {
            "level": "values",
            "text": "Зачем вам порядок?",
            "options": {
                "PROBLEM": "Не знаю зачем",
                "PROBLEM_ALT": "Не понимаю смысла",
                "OK": "Знаю зачем"
            }
        },
        {
            "level": "values",
            "text": "Что для вас важно в системах?",
            "options": {
                "PROBLEM": "Не понимаю что",
                "PROBLEM_ALT": "Запутался в ценностях",
                "OK": "Понимаю"
            }
        },
        {
            "level": "identity",
            "text": "Кто вы в мире систем?",
            "options": {
                "PROBLEM": "Не знаю кто",
                "PROBLEM_ALT": "Хаотичный",
                "OK": "Знаю кто я"
            }
        },
        {
            "level": "identity",
            "text": "Вы чувствуете себя упорядоченным?",
            "options": {
                "PROBLEM": "Нет, я хаос",
                "PROBLEM_ALT": "Не понимаю, кто я",
                "OK": "Да, я структурен"
            }
        },
        {
            "level": "mission",
            "text": "Для чего вы создаёте порядок?",
            "options": {
                "PROBLEM": "Не знаю для чего",
                "PROBLEM_ALT": "Не вижу смысла",
                "OK": "Знаю свою миссию"
            }
        },
        {
            "level": "mission",
            "text": "Какой ваш вклад в мир через системы?",
            "options": {
                "PROBLEM": "Нет вклада",
                "PROBLEM_ALT": "Не понимаю зачем я",
                "OK": "Понимаю миссию"
            }
        }
    ]
}

# ========== ТАБЛИЦА НАЧИСЛЕНИЯ БАЛЛОВ ДЛЯ ЭТАПА 2 ==========
STAGE_2_SCORING = {
    "clubs": {
        0: {"6": 2, "7": 2, "8": 2, "9": 2},
        1: {"6": 2, "7": 2, "8": 2, "9": 2},
        2: {"6": 2, "7": 2, "8": 2, "9": 2},
        3: {"6": 2, "7": 2, "8": 2, "9": 2},
        4: {"6": 2, "7": 2, "8": 2, "9": 2},
        5: {"6": 2, "7": 2, "8": 2, "9": 2},
        6: {"6": 2, "7": 2, "8": 2, "9": 2},
        7: {"6": 2, "7": 2, "8": 2, "9": 2},
        8: {"6": 2, "7": 2, "8": 2, "9": 2},
        9: {"6": 2, "7": 2, "8": 2, "9": 2},
        10: {"6": 1, "7": 1, "8": 1, "10": 2},
        11: {"7": 1, "8": 1, "9": 1, "10": 2},
        12: {"8": 2, "9": 2, "10": 2, "J": 2},
        13: {"9": 2, "10": 2, "J": 2, "Q": 2},
        14: {"J": 2, "Q": 2, "K": 2, "A": 2},
        15: {"10": 2, "J": 2, "Q": 2, "K": 2},
        16: {"J": 2, "Q": 2, "K": 2, "A": 2},
        17: {"Q": 2, "K": 2, "A": 2, "10": 1}
    },
    "hearts": {
        0: {"6": 2, "7": 2, "8": 2, "9": 2},
        1: {"6": 2, "7": 2, "8": 2, "9": 2},
        2: {"6": 2, "7": 2, "8": 2, "9": 2},
        3: {"6": 2, "7": 2, "8": 2, "9": 2},
        4: {"6": 2, "7": 2, "8": 2, "9": 2},
        5: {"6": 2, "7": 2, "8": 2, "9": 2},
        6: {"6": 2, "7": 2, "8": 2, "9": 2},
        7: {"6": 2, "7": 2, "8": 2, "9": 2},
        8: {"6": 2, "7": 2, "8": 2, "9": 2},
        9: {"6": 2, "7": 2, "8": 2, "9": 2},
        10: {"6": 1, "7": 1, "8": 1, "10": 2},
        11: {"7": 1, "8": 1, "9": 1, "10": 2},
        12: {"8": 2, "9": 2, "10": 2, "J": 2},
        13: {"9": 2, "10": 2, "J": 2, "Q": 2},
        14: {"J": 2, "Q": 2, "K": 2, "A": 2},
        15: {"10": 2, "J": 2, "Q": 2, "K": 2},
        16: {"J": 2, "Q": 2, "K": 2, "A": 2},
        17: {"Q": 2, "K": 2, "A": 2, "10": 1}
    },
    "diamonds": {
        0: {"6": 2, "7": 2, "8": 2, "9": 2},
        1: {"6": 2, "7": 2, "8": 2, "9": 2},
        2: {"6": 2, "7": 2, "8": 2, "9": 2},
        3: {"6": 2, "7": 2, "8": 2, "9": 2},
        4: {"6": 2, "7": 2, "8": 2, "9": 2},
        5: {"6": 2, "7": 2, "8": 2, "9": 2},
        6: {"6": 2, "7": 2, "8": 2, "9": 2},
        7: {"6": 2, "7": 2, "8": 2, "9": 2},
        8: {"6": 2, "7": 2, "8": 2, "9": 2},
        9: {"6": 2, "7": 2, "8": 2, "9": 2},
        10: {"6": 1, "7": 1, "8": 1, "10": 2},
        11: {"7": 1, "8": 1, "9": 1, "10": 2},
        12: {"8": 2, "9": 2, "10": 2, "J": 2},
        13: {"9": 2, "10": 2, "J": 2, "Q": 2},
        14: {"J": 2, "Q": 2, "K": 2, "A": 2},
        15: {"10": 2, "J": 2, "Q": 2, "K": 2},
        16: {"J": 2, "Q": 2, "K": 2, "A": 2},
        17: {"Q": 2, "K": 2, "A": 2, "10": 1}
    },
    "spades": {
        0: {"6": 2, "7": 2, "8": 2, "9": 2},
        1: {"6": 2, "7": 2, "8": 2, "9": 2},
        2: {"6": 2, "7": 2, "8": 2, "9": 2},
        3: {"6": 2, "7": 2, "8": 2, "9": 2},
        4: {"6": 2, "7": 2, "8": 2, "9": 2},
        5: {"6": 2, "7": 2, "8": 2, "9": 2},
        6: {"6": 2, "7": 2, "8": 2, "9": 2},
        7: {"6": 2, "7": 2, "8": 2, "9": 2},
        8: {"6": 2, "7": 2, "8": 2, "9": 2},
        9: {"6": 2, "7": 2, "8": 2, "9": 2},
        10: {"6": 1, "7": 1, "8": 1, "10": 2},
        11: {"7": 1, "8": 1, "9": 1, "10": 2},
        12: {"8": 2, "9": 2, "10": 2, "J": 2},
        13: {"9": 2, "10": 2, "J": 2, "Q": 2},
        14: {"J": 2, "Q": 2, "K": 2, "A": 2},
        15: {"10": 2, "J": 2, "Q": 2, "K": 2},
        16: {"J": 2, "Q": 2, "K": 2, "A": 2},
        17: {"Q": 2, "K": 2, "A": 2, "10": 1}
    }
}

# ========== ФУНКЦИИ ДЛЯ РАБОТЫ С РЕЗУЛЬТАТАМИ ==========
def calculate_progress(current: int, total: int) -> str:
    """Вычисляет прогресс"""
    progress = int((current / total) * 100)
    filled = int(progress / 10)
    bar = "▓" * filled + "░" * (10 - filled)
    return f"{bar} {progress}%\n📊 Пройдено: {current} из {total}"

def get_suit_by_axes(control_value: float, internal_value: float, scores: dict) -> str:
    """Определяет масть по осям"""
    if control_value >= 0 and internal_value >= 0:
        return "clubs"
    elif control_value < 0 and internal_value >= 0:
        return "hearts"
    elif control_value >= 0 and internal_value < 0:
        return "diamonds"
    else:
        return "spades"

def get_card_by_scores(scores: dict) -> str:
    """Определяет карту по баллам"""
    return max(scores, key=scores.get)

def get_problem_level_by_scores(scores: dict) -> str:
    """Определяет проблемный уровень по максимальному баллу"""
    if not scores or all(v == 0 for v in scores.values()):
        return "environment"
    return max(scores, key=scores.get)

# ========== ОБРАБОТЧИКИ КОМАНД И CALLBACK ==========

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Команда /start"""
    user = update.effective_user
    welcome_text = (
        f"👁 <b>ЧЕЛОВЕК В КРАСНЫХ ОЧКАХ НЕ ВИДИТ КРАСНОГО</b>\n\n"
        f"Он смотрит сквозь красное. Для него оно прозрачно.\n"
        f"Даже когда он подходит к зеркалу — он видит прозрачные линзы.\n"
        f"Красный фильтр поглощает сам себя.\n\n"
        f"Вы тоже носите очки. Но не знаете, какого они цвета.\n"
        f"Этот тест — ваше зеркало. Он покажет фильтр, через который вы живёте.\n\n"
        f"━━━━━━━━━━━━━━━━━━━━\n\n"
        f"🎯 <b>ЧТО ВАС ЖДЁТ</b>\n\n"
        f"1️⃣ <b>Этап 1: Конфигурация восприятия</b>\n"
        f"Определим ваш базовый фильтр — через что вы воспринимаете реальность (16 вопросов)\n\n"
        f"2️⃣ <b>Этап 2: Конфигурация мышления</b>\n"
        f"Определим ваш профиль — как вы обрабатываете информацию и принимаете решения (18 вопросов)\n\n"
        f"3️⃣ <b>Этап 3: Конфигурация поведенческих паттернов</b>\n"
        f"Определим проблемный уровень — где застряла ваша проблема (12 вопросов)\n\n"
        f"━━━━━━━━━━━━━━━━━━━━\n\n"
        f"🎁 <b>ВЫ ПОЛУЧИТЕ</b>\n"
        f"✅ Свой фильтр — через что вы смотрите на мир\n"
        f"✅ Слепые зоны — чего вы в себе не замечаете\n"
        f"✅ Ловушка паттерна — почему вы повторяете одно и то же\n"
        f"✅ Заплатка — как выйти из цикла\n\n"
        f"⏱ Займёт 10–15 минут"
    )
    keyboard = [
        [InlineKeyboardButton("🚀 Начать тест", callback_data="start_test")],
        [InlineKeyboardButton("💡 Подробнее", callback_data="show_details")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text(welcome_text, reply_markup=reply_markup, parse_mode="HTML")

async def show_details(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Показать подробности о тесте"""
    query = update.callback_query
    await query.answer()
    
    details_text = (
        f"💡 <b>КАК ЭТО РАБОТАЕТ</b>\n\n"
        f"📍 <b>Конфигурация восприятия (твоё «железо»)</b>\n"
        f"Через что ты фильтруешь реальность:\n"
        f"• Связи и отношения\n"
        f"• Чувства и смыслы\n"
        f"• Действие и результат\n"
        f"• Мысли и системы\n\n"
        f"🧠 <b>Конфигурация мышления (твои «программы»)</b>\n"
        f"Как ты обрабатываешь информацию:\n"
        f"• Базовый уровень — начальная стадия\n"
        f"• Развивающийся уровень — поиск и рост\n"
        f"• Продвинутый уровень — адаптация\n"
        f"• Мастерский уровень — интеграция\n\n"
        f"🎭 <b>Конфигурация поведенческих паттернов (твои «баги»)</b>\n"
        f"Где застряла твоя проблема:\n"
        f"• Окружение — где и с кем\n"
        f"• Поведение — что делаю\n"
        f"• Способности — что умею\n"
        f"• Ценности — во что верю\n"
        f"• Идентичность — кто я\n"
        f"• Миссия — зачем я здесь\n\n"
        f"━━━━━━━━━━━━━━━━━━━━\n\n"
        f"⚠️ Проблема всегда возникает на стыке конфигураций.\n"
        f"🎯 Тест найдёт этот стык.\n\n"
        f"🚀 <b>ГОТОВЫ УВИДЕТЬ СВОИ ОЧКИ?</b>"
    )
    keyboard = [
        [InlineKeyboardButton("🚀 Начать тест", callback_data="start_test")],
        [InlineKeyboardButton("◀️ Назад", callback_data="back_to_start")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text(details_text, reply_markup=reply_markup, parse_mode="HTML")

async def back_to_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Вернуться к начальному экрану"""
    query = update.callback_query
    await query.answer()
    
    welcome_text = (
        f"👁 <b>ЧЕЛОВЕК В КРАСНЫХ ОЧКАХ НЕ ВИДИТ КРАСНОГО</b>\n\n"
        f"Он смотрит сквозь красное. Для него оно прозрачно.\n"
        f"Даже когда он подходит к зеркалу — он видит прозрачные линзы.\n"
        f"Красный фильтр поглощает сам себя.\n\n"
        f"Вы тоже носите очки. Но не знаете, какого они цвета.\n"
        f"Этот тест — ваше зеркало. Он покажет фильтр, через который вы живёте.\n\n"
        f"━━━━━━━━━━━━━━━━━━━━\n\n"
        f"🎯 <b>ЧТО ВАС ЖДЁТ</b>\n\n"
        f"1️⃣ <b>Этап 1: Конфигурация восприятия</b>\n"
        f"Определим ваш базовый фильтр — через что вы воспринимаете реальность (16 вопросов)\n\n"
        f"2️⃣ <b>Этап 2: Конфигурация мышления</b>\n"
        f"Определим ваш профиль — как вы обрабатываете информацию и принимаете решения (18 вопросов)\n\n"
        f"3️⃣ <b>Этап 3: Конфигурация поведенческих паттернов</b>\n"
        f"Определим проблемный уровень — где застряла ваша проблема (12 вопросов)\n\n"
        f"━━━━━━━━━━━━━━━━━━━━\n\n"
        f"🎁 <b>ВЫ ПОЛУЧИТЕ</b>\n"
        f"✅ Свой фильтр — через что вы смотрите на мир\n"
        f"✅ Слепые зоны — чего вы в себе не замечаете\n"
        f"✅ Ловушка паттерна — почему вы повторяете одно и то же\n"
        f"✅ Заплатка — как выйти из цикла\n\n"
        f"⏱ Займёт 10–15 минут"
    )
    keyboard = [
        [InlineKeyboardButton("🚀 Начать тест", callback_data="start_test")],
        [InlineKeyboardButton("💡 Подробнее", callback_data="show_details")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text(welcome_text, reply_markup=reply_markup, parse_mode="HTML")

async def start_test(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Начало теста"""
    query = update.callback_query
    await query.answer()
    
    context.user_data["stage_1_scores"] = {
        "VOVNE": 0,
        "VNUTR": 0,
        "UMOZ": 0,
        "FAKT": 0
    }
    context.user_data["stage_2_scores"] = {
        "6": 0, "7": 0, "8": 0, "9": 0, "10": 0,
        "J": 0, "Q": 0, "K": 0, "A": 0
    }
    context.user_data["stage_3_scores"] = {
        "environment": 0,
        "behavior": 0,
        "capabilities": 0,
        "values": 0,
        "identity": 0,
        "mission": 0
    }
    context.user_data["current_question"] = 0
    
    intro_text = (
        f"🎯 <b>ЭТАП 1: КОНФИГУРАЦИЯ ВОСПРИЯТИЯ</b>\n\n"
        f"Сейчас я задам 16 вопросов, чтобы определить твою систему конфигурации восприятия.\n\n"
        f"Это твой базовый фильтр, через который ты смотришь на мир.\n\n"
        f"Отвечай интуитивно, первое что приходит в голову."
    )
    keyboard = [[InlineKeyboardButton("▶️ Начать", callback_data="start_stage_1")]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text(intro_text, reply_markup=reply_markup, parse_mode="HTML")
    return STAGE_1

async def start_stage_1(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Начало ЭТАПА 1"""
    query = update.callback_query
    await query.answer()
    return await ask_stage_1_question(update, context)

async def ask_stage_1_question(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Задаёт вопрос ЭТАПА 1"""
    query = update.callback_query if update.callback_query else None
    
    current_q = context.user_data["current_question"]
    question = STAGE_1_QUESTIONS[current_q]
    progress = calculate_progress(current_q, 16)
    
    question_text = (
        f"🎯 <b>ЭТАП 1: КОНФИГУРАЦИЯ ВОСПРИЯТИЯ</b>\n\n"
        f"<b>{question['text']}</b>\n\n"
        f"{progress}"
    )
    
    keyboard = []
    for key, answer in question["options"].items():
        keyboard.append([InlineKeyboardButton(answer, callback_data=f"s1_{key}")])
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    if query:
        await query.edit_message_text(question_text, reply_markup=reply_markup, parse_mode="HTML")
    else:
        await update.message.reply_text(question_text, reply_markup=reply_markup, parse_mode="HTML")
    
    return STAGE_1

async def handle_stage_1_answer(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Обработка ответа ЭТАПА 1"""
    query = update.callback_query
    await query.answer()
    
    answer = query.data.split("_")[1]
    
    if answer in ["VOVNE", "VNUTR", "UMOZ", "FAKT"]:
        context.user_data["stage_1_scores"][answer] += 1
    
    context.user_data["current_question"] += 1
    current_q = context.user_data["current_question"]
    
    if current_q >= 16:
        return await finish_stage_1(update, context)
    
    return await ask_stage_1_question(update, context)

async def finish_stage_1(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Завершение ЭТАПА 1"""
    query = update.callback_query
    scores = context.user_data["stage_1_scores"]
    
    control_value = scores.get("VOVNE", 0) - scores.get("VNUTR", 0)
    internal_value = scores.get("UMOZ", 0) - scores.get("FAKT", 0)
    
    suit = get_suit_by_axes(control_value, internal_value, scores)
    
    context.user_data["suit"] = suit
    context.user_data["current_question"] = 0
    
    # Получаем ПОЛНОЕ описание из файла
    suit_data = SUIT_DESCRIPTIONS.get(suit, {})
    
    result_text = (
        f"🎯 <b>ВАШ ТИП ВОСПРИЯТИЯ</b>\n\n"
        f"<b>{suit_data.get('title', 'Неизвестный тип')}</b>\n\n"
        f"{suit_data.get('description', 'Описание отсутствует')}\n\n"
        f"<b>🔍 Ваш фильтр:</b>\n{suit_data.get('filter', 'Не определён')}\n\n"
        f"<b>👁 Слепая зона:</b>\n{suit_data.get('blind_spot', 'Не определена')}\n\n"
        f"<b>🎭 Ловушка паттерна:</b>\n{suit_data.get('trap', 'Не определена')}\n\n"
        f"<b>💡 Заплатка:</b>\n{suit_data.get('solution', 'Не определена')}"
    )
    
    keyboard = [
        [InlineKeyboardButton("🔍 Подробнее о расчётах", callback_data="show_stage1_details")],
        [InlineKeyboardButton("▶️ Продолжить к Этапу 2", callback_data="start_stage_2")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(result_text, reply_markup=reply_markup, parse_mode="HTML")
    return STAGE_2

async def show_stage1_details(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Показать детальную аналитику Этапа 1"""
    query = update.callback_query
    await query.answer()
    
    scores = context.user_data["stage_1_scores"]
    suit = context.user_data["suit"]
    
    control = scores.get("VOVNE", 0) - scores.get("VNUTR", 0)
    internal = scores.get("UMOZ", 0) - scores.get("FAKT", 0)
    total = sum(scores.values())
    percentages = {k: (v / total * 100) if total > 0 else 0 for k, v in scores.items()}
    
    analytics_text = (
        f"🔍 <b>ДЕТАЛЬНАЯ АНАЛИТИКА ЭТАПА 1</b>\n"
        f"<b>КОНФИГУРАЦИЯ ВОСПРИЯТИЯ</b>\n\n"
        f"<b>Координаты на осях:</b>\n"
        f"• Ось контроля (X): <b>{control:+.1f}</b> "
        f"{'(внешний фокус — МЫ)' if control >= 0 else '(внутренний фокус — Я)'}\n"
        f"• Ось страха (Y): <b>{internal:+.1f}</b> "
        f"{'(умозрительное — ЧУВСТВА)' if internal >= 0 else '(фактическое — МЫСЛИ)'}\n\n"
        f"<b>Процентное распределение:</b>\n"
        f"• Внешний фокус (VOVNE): {percentages.get('VOVNE', 0):.1f}%\n"
        f"• Внутренний фокус (VNUTR): {percentages.get('VNUTR', 0):.1f}%\n"
        f"• Страх умозрительного (UMOZ): {percentages.get('UMOZ', 0):.1f}%\n"
        f"• Страх фактического (FAKT): {percentages.get('FAKT', 0):.1f}%\n\n"
        f"<b>Абсолютные значения:</b>\n"
        f"• VOVNE: {scores.get('VOVNE', 0)} баллов\n"
        f"• VNUTR: {scores.get('VNUTR', 0)} баллов\n"
        f"• UMOZ: {scores.get('UMOZ', 0)} баллов\n"
        f"• FAKT: {scores.get('FAKT', 0)} баллов\n"
        f"• <b>Всего: {total} баллов</b>"
    )
    
    keyboard = [
        [InlineKeyboardButton("◀️ Назад к описанию", callback_data="back_to_stage1_result")],
        [InlineKeyboardButton("▶️ Продолжить к Этапу 2", callback_data="start_stage_2")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text(analytics_text, reply_markup=reply_markup, parse_mode="HTML")

async def back_to_stage1_result(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Вернуться к результату этапа 1"""
    query = update.callback_query
    await query.answer()
    
    scores = context.user_data["stage_1_scores"]
    suit = context.user_data["suit"]
    
    suit_data = SUIT_DESCRIPTIONS.get(suit, {})
    
    result_text = (
        f"🎯 <b>ВАШ ТИП ВОСПРИЯТИЯ</b>\n\n"
        f"<b>{suit_data.get('title', 'Неизвестный тип')}</b>\n\n"
        f"{suit_data.get('description', 'Описание отсутствует')}\n\n"
        f"<b>🔍 Ваш фильтр:</b>\n{suit_data.get('filter', 'Не определён')}\n\n"
        f"<b>👁 Слепая зона:</b>\n{suit_data.get('blind_spot', 'Не определена')}\n\n"
        f"<b>🎭 Ловушка паттерна:</b>\n{suit_data.get('trap', 'Не определена')}\n\n"
        f"<b>💡 Заплатка:</b>\n{suit_data.get('solution', 'Не определена')}"
    )
    
    keyboard = [
        [InlineKeyboardButton("🔍 Подробнее о расчётах", callback_data="show_stage1_details")],
        [InlineKeyboardButton("▶️ Продолжить к Этапу 2", callback_data="start_stage_2")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text(result_text, reply_markup=reply_markup, parse_mode="HTML")

async def start_stage_2(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Начало ЭТАПА 2"""
    query = update.callback_query
    await query.answer()
    
    intro_text = (
        f"🎯 <b>ЭТАП 2: КОНФИГУРАЦИЯ МЫШЛЕНИЯ</b>\n\n"
        f"Сейчас я задам 18 вопросов, чтобы определить твою конфигурацию мышления.\n\n"
        f"Это твой профиль — как ты обрабатываешь информацию и принимаешь решения.\n\n"
        f"Отвечай честно, выбирай то, что ближе всего."
    )
    keyboard = [[InlineKeyboardButton("▶️ Начать", callback_data="start_stage_2_questions")]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text(intro_text, reply_markup=reply_markup, parse_mode="HTML")
    return STAGE_2

async def start_stage_2_questions(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Начало вопросов ЭТАПА 2"""
    query = update.callback_query
    await query.answer()
    context.user_data["current_question"] = 0
    return await ask_stage_2_question(update, context)

async def ask_stage_2_question(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Задаёт вопрос ЭТАПА 2"""
    query = update.callback_query if update.callback_query else None
    
    suit = context.user_data["suit"]
    current_q = context.user_data["current_question"]
    question = STAGE_2_QUESTIONS[suit][current_q]
    progress = calculate_progress(current_q, 18)
    
    question_text = (
        f"🎯 <b>ЭТАП 2: КОНФИГУРАЦИЯ МЫШЛЕНИЯ</b>\n\n"
        f"<b>{question['text']}</b>\n\n"
        f"{progress}"
    )
    
    keyboard = []
    for card, answer in question["options"].items():
        keyboard.append([InlineKeyboardButton(answer, callback_data=f"s2_{card}")])
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    if query:
        await query.edit_message_text(question_text, reply_markup=reply_markup, parse_mode="HTML")
    else:
        await update.message.reply_text(question_text, reply_markup=reply_markup, parse_mode="HTML")
    
    return STAGE_2

async def handle_stage_2_answer(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Обработка ответа ЭТАПА 2"""
    query = update.callback_query
    await query.answer()
    
    card = query.data.split("_")[1]
    suit = context.user_data["suit"]
    current_q = context.user_data["current_question"]
    
    scoring = STAGE_2_SCORING[suit][current_q]
    if card in scoring:
        context.user_data["stage_2_scores"][card] += scoring[card]
    
    context.user_data["current_question"] += 1
    current_q = context.user_data["current_question"]
    
    if current_q >= 18:
        return await finish_stage_2(update, context)
    
    return await ask_stage_2_question(update, context)

async def finish_stage_2(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Завершение ЭТАПА 2"""
    query = update.callback_query
    scores = context.user_data["stage_2_scores"]
    suit = context.user_data["suit"]
    
    card = get_card_by_scores(scores)
    
    context.user_data["card"] = card
    context.user_data["current_question"] = 0
    
    # Получаем ПОЛНОЕ описание из файла
    profile_key = f"{suit}_{card}"
    profile_data = STAGE_2_PROFILES.get(profile_key, {})
    
    result_text = (
        f"🎯 <b>ВАШ ПРОФИЛЬ МЫШЛЕНИЯ</b>\n\n"
        f"<b>{profile_data.get('title', 'Неизвестный профиль')}</b>\n\n"
        f"{profile_data.get('description', 'Описание отсутствует')}\n\n"
        f"<b>🔍 Как вы мыслите:</b>\n{profile_data.get('thinking', 'Не определено')}\n\n"
        f"<b>👁 Слепая зона:</b>\n{profile_data.get('blind_spot', 'Не определена')}\n\n"
        f"<b>🎭 Ловушка:</b>\n{profile_data.get('trap', 'Не определена')}\n\n"
        f"<b>💡 Заплатка:</b>\n{profile_data.get('solution', 'Не определена')}"
    )
    
    keyboard = [
        [InlineKeyboardButton("🔍 Подробнее о расчётах", callback_data="show_stage2_details")],
        [InlineKeyboardButton("▶️ Продолжить к Этапу 3", callback_data="start_stage_3")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(result_text, reply_markup=reply_markup, parse_mode="HTML")
    return STAGE_3

async def show_stage2_details(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Показать детальную аналитику Этапа 2"""
    query = update.callback_query
    await query.answer()
    
    scores = context.user_data["stage_2_scores"]
    suit = context.user_data["suit"]
    card = context.user_data["card"]
    
    total = sum(scores.values())
    
    analytics_text = (
        f"🔍 <b>ДЕТАЛЬНАЯ АНАЛИТИКА ЭТАПА 2</b>\n"
        f"<b>КОНФИГУРАЦИЯ МЫШЛЕНИЯ</b>\n\n"
        f"<b>Ваш профиль:</b> Карта {card}\n\n"
        f"<b>Баллы по картам:</b>\n"
    )
    
    # Сортируем карты по баллам
    sorted_scores = sorted(scores.items(), key=lambda x: x[1], reverse=True)
    for card_key, score in sorted_scores:
        if score > 0:
            percentage = (score / total * 100) if total > 0 else 0
            bar = "▓" * (score // 2) + "░" * (10 - score // 2)
            analytics_text += f"• Карта {card_key}: {score} баллов ({percentage:.1f}%) {bar}\n"
    
    analytics_text += f"\n<b>Всего баллов:</b> {total}"
    
    keyboard = [
        [InlineKeyboardButton("◀️ Назад к описанию", callback_data="back_to_stage2_result")],
        [InlineKeyboardButton("▶️ Продолжить к Этапу 3", callback_data="start_stage_3")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text(analytics_text, reply_markup=reply_markup, parse_mode="HTML")

async def back_to_stage2_result(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Вернуться к результату этапа 2"""
    query = update.callback_query
    await query.answer()
    
    scores = context.user_data["stage_2_scores"]
    suit = context.user_data["suit"]
    card = context.user_data["card"]
    
    profile_key = f"{suit}_{card}"
    profile_data = STAGE_2_PROFILES.get(profile_key, {})
    
    result_text = (
        f"🎯 <b>ВАШ ПРОФИЛЬ МЫШЛЕНИЯ</b>\n\n"
        f"<b>{profile_data.get('title', 'Неизвестный профиль')}</b>\n\n"
        f"{profile_data.get('description', 'Описание отсутствует')}\n\n"
        f"<b>🔍 Как вы мыслите:</b>\n{profile_data.get('thinking', 'Не определено')}\n\n"
        f"<b>👁 Слепая зона:</b>\n{profile_data.get('blind_spot', 'Не определена')}\n\n"
        f"<b>🎭 Ловушка:</b>\n{profile_data.get('trap', 'Не определена')}\n\n"
        f"<b>💡 Заплатка:</b>\n{profile_data.get('solution', 'Не определена')}"
    )
    
    keyboard = [
        [InlineKeyboardButton("🔍 Подробнее о расчётах", callback_data="show_stage2_details")],
        [InlineKeyboardButton("▶️ Продолжить к Этапу 3", callback_data="start_stage_3")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text(result_text, reply_markup=reply_markup, parse_mode="HTML")

async def start_stage_3(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Начало ЭТАПА 3"""
    query = update.callback_query
    await query.answer()
    
    intro_text = (
        f"🎯 <b>ЭТАП 3: КОНФИГУРАЦИЯ ПОВЕДЕНЧЕСКИХ ПАТТЕРНОВ</b>\n\n"
        f"Последний этап! Сейчас я задам 12 вопросов, чтобы определить, на каком уровне находится твоя проблема.\n\n"
        f"Это твой проблемный уровень — где застрял твой паттерн поведения.\n\n"
        f"Отвечай честно, не думай долго."
    )
    keyboard = [[InlineKeyboardButton("▶️ Начать", callback_data="start_stage_3_questions")]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text(intro_text, reply_markup=reply_markup, parse_mode="HTML")
    return STAGE_3

async def start_stage_3_questions(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Начало вопросов ЭТАПА 3"""
    query = update.callback_query
    await query.answer()
    context.user_data["current_question"] = 0
    return await ask_stage_3_question(update, context)

async def ask_stage_3_question(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Задаёт вопрос ЭТАПА 3"""
    query = update.callback_query if update.callback_query else None
    
    suit = context.user_data["suit"]
    current_q = context.user_data["current_question"]
    question = STAGE_3_QUESTIONS[suit][current_q]
    progress = calculate_progress(current_q, 12)
    
    question_text = (
        f"🎯 <b>ЭТАП 3: КОНФИГУРАЦИЯ ПОВЕДЕНЧЕСКИХ ПАТТЕРНОВ</b>\n\n"
        f"<b>{question['text']}</b>\n\n"
        f"{progress}"
    )
    
    keyboard = []
    for key, answer in question["options"].items():
        keyboard.append([InlineKeyboardButton(answer, callback_data=f"s3_{key}")])
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    if query:
        await query.edit_message_text(question_text, reply_markup=reply_markup, parse_mode="HTML")
    

    else:
        await update.message.reply_text(question_text, reply_markup=reply_markup, parse_mode="HTML")
    
    return STAGE_3

async def handle_stage_3_answer(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Обработка ответа ЭТАПА 3"""
    query = update.callback_query
    await query.answer()
    
    answer_type = query.data.split("_")[1]
    suit = context.user_data["suit"]
    current_q = context.user_data["current_question"]
    question = STAGE_3_QUESTIONS[suit][current_q]
    level = question["level"]
    
    # Начисляем баллы за проблемные ответы
    if answer_type in ["PROBLEM", "PROBLEM_ALT"]:
        context.user_data["stage_3_scores"][level] += 2
    
    context.user_data["current_question"] += 1
    current_q = context.user_data["current_question"]
    
    if current_q >= 12:
        return await finish_stage_3(update, context)
    
    return await ask_stage_3_question(update, context)

async def finish_stage_3(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Завершение ЭТАПА 3 и показ финального результата"""
    query = update.callback_query
    
    suit = context.user_data["suit"]
    card = context.user_data["card"]
    scores = context.user_data["stage_3_scores"]
    problem_level = get_problem_level_by_scores(scores)
    
    # Получаем описание из файла
    result_key = f"{suit}_{card}_{problem_level}"
    result_data = STAGE_3_RESULTS.get(result_key, {})
    
    level_names = {
        "environment": "Окружение",
        "behavior": "Поведение",
        "capabilities": "Способности",
        "values": "Ценности",
        "identity": "Идентичность",
        "mission": "Миссия"
    }
    
    result_text = (
        f"🎯 <b>ФИНАЛЬНЫЙ РЕЗУЛЬТАТ</b>\n\n"
        f"<b>Ваша конфигурация:</b>\n"
        f"• Тип восприятия: {SUIT_DESCRIPTIONS.get(suit, {}).get('title', 'Неизвестно')}\n"
        f"• Профиль мышления: {STAGE_2_PROFILES.get(f'{suit}_{card}', {}).get('title', 'Неизвестно')}\n"
        f"• Проблемный уровень: <b>{level_names.get(problem_level, problem_level)}</b>\n\n"
        f"━━━━━━━━━━━━━━━━━━━━\n\n"
        f"<b>{result_data.get('title', 'Ваша проблема')}</b>\n\n"
        f"{result_data.get('description', 'Описание отсутствует')}\n\n"
        f"<b>🎭 Ваша ловушка:</b>\n{result_data.get('trap', 'Не определена')}\n\n"
        f"<b>💡 Ваша заплатка:</b>\n{result_data.get('solution', 'Не определена')}\n\n"
        f"<b>🔧 Что делать:</b>\n{result_data.get('action', 'Не определено')}"
    )
    
    result_text += (
        f"\n\n━━━━━━━━━━━━━━━━━━━━\n\n"
        f"📖 <b>СКАЗКА-ПЕРЕДЫШКА</b>\n\n"
        f"<i>Что такое терапевтическая сказка?</i>\n\n"
        f"Это работа с бессознательным через метафору. Сказка обходит защиты разума "
        f"и показывает выход из твоего паттерна.\n\n"
        f"💰 <b>Стоимость:</b> 500₽\n"
        f"⏱ <b>Готовность:</b> 24 часа\n\n"
        f"Сказка будет написана персонально под твою конфигурацию.\n\n"
        f"Это не развлечение. Это инструмент трансформации."
    )
    
    keyboard = [
        [InlineKeyboardButton("🔍 Подробнее о расчётах", callback_data="show_final_details")],
        [InlineKeyboardButton("💳 Заказать сказку (500₽)", callback_data="order_story")],
        [InlineKeyboardButton("🔄 Пройти тест заново", callback_data="restart_test")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(result_text, reply_markup=reply_markup, parse_mode="HTML")
    return ConversationHandler.END

async def show_final_details(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Показать полную аналитику всех 3 этапов"""
    query = update.callback_query
    await query.answer()
    
    # ЭТАП 1
    stage1_scores = context.user_data["stage_1_scores"]
    suit = context.user_data["suit"]
    control = stage1_scores.get("VOVNE", 0) - stage1_scores.get("VNUTR", 0)
    internal = stage1_scores.get("UMOZ", 0) - stage1_scores.get("FAKT", 0)
    
    # ЭТАП 2
    stage2_scores = context.user_data["stage_2_scores"]
    card = context.user_data["card"]
    
    # ЭТАП 3
    stage3_scores = context.user_data["stage_3_scores"]
    problem_level = get_problem_level_by_scores(stage3_scores)
    
    level_names = {
        "environment": "Окружение",
        "behavior": "Поведение",
        "capabilities": "Способности",
        "values": "Ценности",
        "identity": "Идентичность",
        "mission": "Миссия"
    }
    
    analytics_text = (
        f"🔍 <b>ПОЛНАЯ АНАЛИТИКА ТЕСТА</b>\n\n"
        f"━━━━━━━━━━━━━━━━━━━━\n"
        f"<b>ЭТАП 1: КОНФИГУРАЦИЯ ВОСПРИЯТИЯ</b>\n\n"
        f"<b>Тип:</b> {SUIT_DESCRIPTIONS.get(suit, {}).get('title', 'Неизвестно')}\n"
        f"<b>Координаты:</b>\n"
        f"• Ось X (контроль): {control:+.1f}\n"
        f"• Ось Y (страх): {internal:+.1f}\n\n"
        f"<b>Баллы:</b>\n"
        f"• VOVNE: {stage1_scores.get('VOVNE', 0)}\n"
        f"• VNUTR: {stage1_scores.get('VNUTR', 0)}\n"
        f"• UMOZ: {stage1_scores.get('UMOZ', 0)}\n"
        f"• FAKT: {stage1_scores.get('FAKT', 0)}\n\n"
        f"━━━━━━━━━━━━━━━━━━━━\n"
        f"<b>ЭТАП 2: КОНФИГУРАЦИЯ МЫШЛЕНИЯ</b>\n\n"
        f"<b>Профиль:</b> Карта {card}\n\n"
        f"<b>Баллы по картам:</b>\n"
    )
    
    sorted_stage2 = sorted(stage2_scores.items(), key=lambda x: x[1], reverse=True)
    for card_key, score in sorted_stage2:
        if score > 0:
            analytics_text += f"• Карта {card_key}: {score} баллов\n"
    
    analytics_text += (
        f"\n━━━━━━━━━━━━━━━━━━━━\n"
        f"<b>ЭТАП 3: КОНФИГУРАЦИЯ ПОВЕДЕНЧЕСКИХ ПАТТЕРНОВ</b>\n\n"
        f"<b>Проблемный уровень:</b> {level_names.get(problem_level, problem_level)}\n\n"
        f"<b>Баллы по уровням:</b>\n"
    )
    
    sorted_stage3 = sorted(stage3_scores.items(), key=lambda x: x[1], reverse=True)
    for level_key, score in sorted_stage3:
        if score > 0:
            analytics_text += f"• {level_names.get(level_key, level_key)}: {score} баллов\n"
    
    analytics_text += (
        f"\n━━━━━━━━━━━━━━━━━━━━\n\n"
        f"<b>ИТОГОВАЯ КОНФИГУРАЦИЯ:</b>\n"
        f"• Восприятие: {SUIT_DESCRIPTIONS.get(suit, {}).get('title', 'Неизвестно')}\n"
        f"• Мышление: Карта {card}\n"
        f"• Проблема: {level_names.get(problem_level, problem_level)}"
    )
    
    keyboard = [
        [InlineKeyboardButton("◀️ Назад к результату", callback_data="back_to_final_result")],
        [InlineKeyboardButton("💳 Заказать сказку (500₽)", callback_data="order_story")],
        [InlineKeyboardButton("🔄 Пройти заново", callback_data="restart_test")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text(analytics_text, reply_markup=reply_markup, parse_mode="HTML")

async def back_to_final_result(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Вернуться к финальному результату"""
    query = update.callback_query
    await query.answer()
    
    suit = context.user_data["suit"]
    card = context.user_data["card"]
    scores = context.user_data["stage_3_scores"]
    problem_level = get_problem_level_by_scores(scores)
    
    result_key = f"{suit}_{card}_{problem_level}"
    result_data = STAGE_3_RESULTS.get(result_key, {})
    
    level_names = {
        "environment": "Окружение",
        "behavior": "Поведение",
        "capabilities": "Способности",
        "values": "Ценности",
        "identity": "Идентичность",
        "mission": "Миссия"
    }
    
    result_text = (
        f"🎯 <b>ФИНАЛЬНЫЙ РЕЗУЛЬТАТ</b>\n\n"
        f"<b>Ваша конфигурация:</b>\n"
        f"• Тип восприятия: {SUIT_DESCRIPTIONS.get(suit, {}).get('title', 'Неизвестно')}\n"
        f"• Профиль мышления: {STAGE_2_PROFILES.get(f'{suit}_{card}', {}).get('title', 'Неизвестно')}\n"
        f"• Проблемный уровень: <b>{level_names.get(problem_level, problem_level)}</b>\n\n"
        f"━━━━━━━━━━━━━━━━━━━━\n\n"
        f"<b>{result_data.get('title', 'Ваша проблема')}</b>\n\n"
        f"{result_data.get('description', 'Описание отсутствует')}\n\n"
        f"<b>🎭 Ваша ловушка:</b>\n{result_data.get('trap', 'Не определена')}\n\n"
        f"<b>💡 Ваша заплатка:</b>\n{result_data.get('solution', 'Не определена')}\n\n"
        f"<b>🔧 Что делать:</b>\n{result_data.get('action', 'Не определено')}"
    )
    
    result_text += (
        f"\n\n━━━━━━━━━━━━━━━━━━━━\n\n"
        f"📖 <b>СКАЗКА-ПЕРЕДЫШКА</b>\n\n"
        f"<i>Что такое терапевтическая сказка?</i>\n\n"
        f"Это работа с бессознательным через метафору. Сказка обходит защиты разума "
        f"и показывает выход из твоего паттерна.\n\n"
        f"💰 <b>Стоимость:</b> 500₽\n"
        f"⏱ <b>Готовность:</b> 24 часа\n\n"
        f"Сказка будет написана персонально под твою конфигурацию.\n\n"
        f"Это не развлечение. Это инструмент трансформации."
    )
    
    keyboard = [
        [InlineKeyboardButton("🔍 Подробнее о расчётах", callback_data="show_final_details")],
        [InlineKeyboardButton("💳 Заказать сказку (500₽)", callback_data="order_story")],
        [InlineKeyboardButton("🔄 Пройти тест заново", callback_data="restart_test")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text(result_text, reply_markup=reply_markup, parse_mode="HTML")

async def order_story(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Обработка заказа сказки"""
    query = update.callback_query
    await query.answer()
    
    suit = context.user_data["suit"]
    card = context.user_data["card"]
    scores = context.user_data["stage_3_scores"]
    problem_level = get_problem_level_by_scores(scores)
    
    level_names = {
        "environment": "Окружение",
        "behavior": "Поведение",
        "capabilities": "Способности",
        "values": "Ценности",
        "identity": "Идентичность",
        "mission": "Миссия"
    }
    
    order_text = (
        f"💳 <b>ЗАКАЗ СКАЗКИ-ПЕРЕДЫШКИ</b>\n\n"
        f"<b>Ваша конфигурация:</b>\n"
        f"• Тип восприятия: {SUIT_DESCRIPTIONS.get(suit, {}).get('title', 'Неизвестно')}\n"
        f"• Профиль мышления: Карта {card}\n"
        f"• Проблемный уровень: {level_names.get(problem_level, problem_level)}\n\n"
        f"<b>Стоимость:</b> 500₽\n"
        f"<b>Срок:</b> 24 часа\n\n"
        f"Для оформления заказа напишите @your_username\n\n"
        f"После оплаты вы получите:\n"
        f"✅ Персональную терапевтическую сказку\n"
        f"✅ Разбор вашего паттерна\n"
        f"✅ Рекомендации по работе с ним\n\n"
        f"<i>Сказка — это не магия. Это технология работы с бессознательным.</i>"
    )
    
    keyboard = [
        [InlineKeyboardButton("◀️ Назад к результату", callback_data="back_to_final_result")],
        [InlineKeyboardButton("🔄 Пройти тест заново", callback_data="restart_test")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text(order_text, reply_markup=reply_markup, parse_mode="HTML")

async def restart_test(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Перезапуск теста"""
    query = update.callback_query
    await query.answer()
    
    # Очищаем данные
    context.user_data.clear()
    
    welcome_text = (
        f"👁 <b>ЧЕЛОВЕК В КРАСНЫХ ОЧКАХ НЕ ВИДИТ КРАСНОГО</b>\n\n"
        f"Он смотрит сквозь красное. Для него оно прозрачно.\n"
        f"Даже когда он подходит к зеркалу — он видит прозрачные линзы.\n"
        f"Красный фильтр поглощает сам себя.\n\n"
        f"Вы тоже носите очки. Но не знаете, какого они цвета.\n"
        f"Этот тест — ваше зеркало. Он покажет фильтр, через который вы живёте.\n\n"
        f"━━━━━━━━━━━━━━━━━━━━\n\n"
        f"🎯 <b>ЧТО ВАС ЖДЁТ</b>\n\n"
        f"1️⃣ <b>Этап 1: Конфигурация восприятия</b>\n"
        f"Определим ваш базовый фильтр — через что вы воспринимаете реальность (16 вопросов)\n\n"
        f"2️⃣ <b>Этап 2: Конфигурация мышления</b>\n"
        f"Определим ваш профиль — как вы обрабатываете информацию и принимаете решения (18 вопросов)\n\n"
        f"3️⃣ <b>Этап 3: Конфигурация поведенческих паттернов</b>\n"
        f"Определим проблемный уровень — где застряла ваша проблема (12 вопросов)\n\n"
        f"━━━━━━━━━━━━━━━━━━━━\n\n"
        f"🎁 <b>ВЫ ПОЛУЧИТЕ</b>\n"
        f"✅ Свой фильтр — через что вы смотрите на мир\n"
        f"✅ Слепые зоны — чего вы в себе не замечаете\n"
        f"✅ Ловушка паттерна — почему вы повторяете одно и то же\n"
        f"✅ Заплатка — как выйти из цикла\n\n"
        f"⏱ Займёт 10–15 минут"
    )
    keyboard = [
        [InlineKeyboardButton("🚀 Начать тест", callback_data="start_test")],
        [InlineKeyboardButton("💡 Подробнее", callback_data="show_details")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text(welcome_text, reply_markup=reply_markup, parse_mode="HTML")

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Отмена теста"""
    await update.message.reply_text(
        "❌ Тест отменён. Используйте /start для начала.",
        parse_mode="HTML"
    )
    return ConversationHandler.END

# ========== ГЛАВНАЯ ФУНКЦИЯ ==========
def main():
    """Запуск бота"""
    application = Application.builder().token(TELEGRAM_BOT_TOKEN).build()
    
    conv_handler = ConversationHandler(
        entry_points=[
            CommandHandler("start", start),
            CallbackQueryHandler(start_test, pattern="^start_test$")
        ],
        states={
            STAGE_1: [
                CallbackQueryHandler(start_stage_1, pattern="^start_stage_1$"),
                CallbackQueryHandler(handle_stage_1_answer, pattern="^s1_"),
                CallbackQueryHandler(show_stage1_details, pattern="^show_stage1_details$"),
                CallbackQueryHandler(back_to_stage1_result, pattern="^back_to_stage1_result$"),
                CallbackQueryHandler(start_stage_2, pattern="^start_stage_2$")
            ],
            STAGE_2: [
                CallbackQueryHandler(start_stage_2_questions, pattern="^start_stage_2_questions$"),
                CallbackQueryHandler(handle_stage_2_answer, pattern="^s2_"),
                CallbackQueryHandler(show_stage2_details, pattern="^show_stage2_details$"),
                CallbackQueryHandler(back_to_stage2_result, pattern="^back_to_stage2_result$"),
                CallbackQueryHandler(start_stage_3, pattern="^start_stage_3$")
            ],
            STAGE_3: [
                CallbackQueryHandler(start_stage_3_questions, pattern="^start_stage_3_questions$"),
                CallbackQueryHandler(handle_stage_3_answer, pattern="^s3_"),
                CallbackQueryHandler(show_final_details, pattern="^show_final_details$"),
                CallbackQueryHandler(back_to_final_result, pattern="^back_to_final_result$"),
                CallbackQueryHandler(order_story, pattern="^order_story$"),
                CallbackQueryHandler(restart_test, pattern="^restart_test$")
            ]
        },
        fallbacks=[
            CommandHandler("cancel", cancel),
            CallbackQueryHandler(show_details, pattern="^show_details$"),
            CallbackQueryHandler(back_to_start, pattern="^back_to_start$")
        ]
    )
    
    application.add_handler(conv_handler)
    
    logger.info("✅ Бот запущен!")
    application.run_polling(allowed_updates=Update.ALL_TYPES)

if __name__ == "__main__":
    main()
