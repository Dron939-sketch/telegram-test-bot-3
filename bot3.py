import os
import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import (
    Application,
    CommandHandler,
    CallbackQueryHandler,
    ContextTypes,
    ConversationHandler,
)

# ========== НАСТРОЙКИ ==========
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
    level=logging.INFO
)
logger = logging.getLogger(__name__)

TELEGRAM_BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
if not TELEGRAM_BOT_TOKEN:
    raise ValueError("❌ ОШИБКА: Переменная TELEGRAM_BOT_TOKEN не установлена!")

# ========== СОСТОЯНИЯ ==========
STAGE_1 = 1  # Определение масти (16 вопросов)
STAGE_2 = 2  # Определение карты (18 вопросов)
STAGE_3 = 3  # Определение проблемного уровня (12 вопросов)

# ========== ЭТАП 1: ОПРЕДЕЛЕНИЕ МАСТИ (16 вопросов) ==========
STAGE_1_QUESTIONS = [
    # ВОПРОСЫ 1-8: ОСЬ X (ФОКУС)
    {
        "axis": "X",
        "text": "Когда у тебя проблема, что ты делаешь в первую очередь?",
        "options": {
            "VOVNE": "Ищу помощь у других людей",
            "VNUTR": "Разбираюсь сам, внутри себя",
            "NEUTRAL": "Зависит от ситуации"
        }
    },
    {
        "axis": "X",
        "text": "Где ты чувствуешь себя лучше?",
        "options": {
            "VOVNE": "Среди людей, в активности",
            "VNUTR": "В одиночестве, в тишине",
            "NEUTRAL": "По-разному"
        }
    },
    {
        "axis": "X",
        "text": "Откуда ты берёшь энергию?",
        "options": {
            "VOVNE": "От общения и внешних событий",
            "VNUTR": "От размышлений и внутренней работы",
            "NEUTRAL": "Из разных источников"
        }
    },
    {
        "axis": "X",
        "text": "Что для тебя важнее?",
        "options": {
            "VOVNE": "Что происходит вокруг меня",
            "VNUTR": "Что происходит внутри меня",
            "NEUTRAL": "И то, и другое"
        }
    },
    {
        "axis": "X",
        "text": "Как ты принимаешь решения?",
        "options": {
            "VOVNE": "Советуюсь с другими, смотрю на факты",
            "VNUTR": "Слушаю себя, свои ощущения",
            "NEUTRAL": "По-разному"
        }
    },
    {
        "axis": "X",
        "text": "Что тебя больше интересует?",
        "options": {
            "VOVNE": "Люди, события, действия",
            "VNUTR": "Мысли, чувства, смыслы",
            "NEUTRAL": "Всё интересно"
        }
    },
    {
        "axis": "X",
        "text": "Когда тебе плохо, ты:",
        "options": {
            "VOVNE": "Иду к людям, ищу поддержку",
            "VNUTR": "Остаюсь один, разбираюсь сам",
            "NEUTRAL": "Зависит от настроения"
        }
    },
    {
        "axis": "X",
        "text": "Что тебя больше мотивирует?",
        "options": {
            "VOVNE": "Внешние цели, результаты, признание",
            "VNUTR": "Внутренняя гармония, понимание себя",
            "NEUTRAL": "И то, и другое"
        }
    },
    
    # ВОПРОСЫ 9-16: ОСЬ Y (СТРАХ)
    {
        "axis": "Y",
        "text": "Чего ты боишься больше?",
        "options": {
            "UMOZ": "Потерять связь с людьми, остаться одному",
            "FAKT": "Потерять контроль, стабильность, ресурсы",
            "NEUTRAL": "Не знаю"
        }
    },
    {
        "axis": "Y",
        "text": "Что для тебя хуже?",
        "options": {
            "UMOZ": "Когда нет смысла, непонятно зачем",
            "FAKT": "Когда нет порядка, всё хаотично",
            "NEUTRAL": "Оба варианта плохи"
        }
    },
    {
        "axis": "Y",
        "text": "Что тебя больше тревожит?",
        "options": {
            "UMOZ": "Отношения с людьми, чувства",
            "FAKT": "Дела, результаты, деньги",
            "NEUTRAL": "Всё тревожит"
        }
    },
    {
        "axis": "Y",
        "text": "Что ты делаешь, когда тревожно?",
        "options": {
            "UMOZ": "Думаю о людях, о смысле",
            "FAKT": "Думаю о делах, о безопасности",
            "NEUTRAL": "О разном"
        }
    },
    {
        "axis": "Y",
        "text": "Что для тебя важнее?",
        "options": {
            "UMOZ": "Понимать, чувствовать, любить",
            "FAKT": "Делать, достигать, контролировать",
            "NEUTRAL": "Всё важно"
        }
    },
    {
        "axis": "Y",
        "text": "Что тебя больше пугает?",
        "options": {
            "UMOZ": "Потерять себя, смысл жизни",
            "FAKT": "Потерять всё, что имею",
            "NEUTRAL": "Оба страха есть"
        }
    },
    {
        "axis": "Y",
        "text": "О чём ты думаешь перед сном?",
        "options": {
            "UMOZ": "О людях, отношениях, чувствах",
            "FAKT": "О делах, проблемах, планах",
            "NEUTRAL": "О разном"
        }
    },
    {
        "axis": "Y",
        "text": "Что тебя больше беспокоит?",
        "options": {
            "UMOZ": "Что меня не понимают, не любят",
            "FAKT": "Что у меня не получается, нет результата",
            "NEUTRAL": "И то, и другое"
        }
    }
]

# ========== ЭТАП 2: ОПРЕДЕЛЕНИЕ КАРТЫ (18 вопросов) ==========
# Вопросы РАЗНЫЕ для каждой масти!

STAGE_2_QUESTIONS = {
    "TF": [  # ТРЕФЫ (Связи, признание, принадлежность)
        {
            "text": "Как ты чувствуешь себя среди людей?",
            "options": {
                "6": "Чужим, не на своём месте",
                "7": "Ищу своих, где мне хорошо",
                "8": "Адаптируюсь, подстраиваюсь",
                "9": "Выполняю свою роль в группе"
            }
        },
        {
            "text": "Что ты делаешь, когда одиноко?",
            "options": {
                "6": "Терплю, жду, когда пройдёт",
                "7": "Активно ищу своих людей",
                "8": "Иду туда, где есть люди",
                "9": "Включаюсь в работу, дела"
            }
        },
        {
            "text": "Как ты строишь отношения?",
            "options": {
                "6": "Сложно, часто не получается",
                "7": "Ищу настоящих, близких",
                "8": "Легко знакомлюсь, общаюсь",
                "9": "Через общие дела, интересы"
            }
        },
        {
            "text": "Что для тебя «свои люди»?",
            "options": {
                "6": "Те, кто примет меня таким",
                "7": "Те, с кем я чувствую связь",
                "8": "Те, с кем выгодно",
                "9": "Коллеги, единомышленники"
            }
        },
        {
            "text": "Как ты реагируешь на отказ?",
            "options": {
                "6": "Больно, замыкаюсь",
                "7": "Ищу дальше, не сдаюсь",
                "8": "Переключаюсь на других",
                "9": "Принимаю, продолжаю работу"
            }
        },
        {
            "text": "Что ты чувствуешь в новой компании?",
            "options": {
                "6": "Тревогу, дискомфорт",
                "7": "Интерес, надежду найти своих",
                "8": "Азарт, возможности",
                "9": "Спокойствие, если понятна роль"
            }
        },
        {
            "text": "Как ты проявляешь себя?",
            "options": {
                "6": "Скромно, незаметно",
                "7": "Ярко, ищу отклик",
                "8": "Гибко, по ситуации",
                "9": "Через дела, результаты"
            }
        },
        {
            "text": "Что для тебя дружба?",
            "options": {
                "6": "Когда меня принимают",
                "7": "Глубокая связь, понимание",
                "8": "Взаимная выгода",
                "9": "Общие цели, интересы"
            }
        },
        {
            "text": "Как ты выбираешь людей?",
            "options": {
                "6": "Кто примет меня",
                "7": "Кто откликается душой",
                "8": "Кто полезен, интересен",
                "9": "Кто разделяет мои ценности"
            }
        },
        {
            "text": "Что ты делаешь для связи?",
            "options": {
                "6": "Жду, когда ко мне придут",
                "7": "Активно ищу, проявляю себя",
                "8": "Создаю возможности для встреч",
                "9": "Участвую в общих делах"
            }
        },
        {
            "text": "Как ты ведёшь себя в конфликте?",
            "options": {
                "6": "Ухожу, избегаю",
                "7": "Отстаиваю свою позицию",
                "8": "Ищу компромисс",
                "10": "Беру ответственность, решаю"
            }
        },
        {
            "text": "Что для тебя команда?",
            "options": {
                "7": "Место, где я ищу своих",
                "8": "Инструмент для целей",
                "9": "Место, где я работаю",
                "10": "То, что я создаю и веду"
            }
        },
        {
            "text": "Как ты влияешь на людей?",
            "options": {
                "8": "Через убеждение, манипуляцию",
                "9": "Через пример, дела",
                "10": "Через лидерство, вдохновение",
                "J": "Через мастерство, авторитет"
            }
        },
        {
            "text": "Что ты даёшь людям?",
            "options": {
                "9": "Надёжность, стабильность",
                "10": "Направление, цель",
                "J": "Мастерство, опыт",
                "Q": "Знания, обучение"
            }
        },
        {
            "text": "Как ты учишь других?",
            "options": {
                "J": "Показываю на своём примере",
                "Q": "Объясняю, передаю систему",
                "K": "Вдохновляю, создаю новое",
                "A": "Просто живу, другие учатся"
            }
        },
        {
            "text": "Что для тебя признание?",
            "options": {
                "10": "Когда за мной идут",
                "J": "Когда уважают моё мастерство",
                "Q": "Когда ценят мои знания",
                "K": "Когда помнят мой вклад"
            }
        },
        {
            "text": "Какова твоя роль в мире?",
            "options": {
                "J": "Мастер своего дела",
                "Q": "Учитель, наставник",
                "K": "Создатель нового",
                "A": "Свободный человек"
            }
        },
        {
            "text": "Что ты оставишь людям?",
            "options": {
                "Q": "Систему, школу",
                "K": "Новую парадигму",
                "A": "Пример свободы",
                "10": "Команду, результаты"
            }
        }
    ],
    
    "CV": [  # ЧЕРВИ (Смысл, глубина, чувства)
        {
            "text": "Что ты чувствуешь в жизни?",
            "options": {
                "6": "Пустоту, бессмысленность",
                "7": "Ищу смысл, глубину",
                "8": "Играю роли, адаптируюсь",
                "9": "Выполняю свою функцию"
            }
        },
        {
            "text": "Что ты делаешь, когда пусто?",
            "options": {
                "6": "Терплю, жду",
                "7": "Ищу то, что наполнит",
                "8": "Отвлекаюсь, развлекаюсь",
                "9": "Погружаюсь в работу"
            }
        },
        {
            "text": "Как ты проживаешь чувства?",
            "options": {
                "6": "Подавляю, не показываю",
                "7": "Ищу способы выразить",
                "8": "Контролирую, использую",
                "9": "Держу в рамках"
            }
        },
        {
            "text": "Что для тебя любовь?",
            "options": {
                "6": "То, чего мне не хватает",
                "7": "То, что я ищу всю жизнь",
                "8": "Инструмент, игра",
                "9": "Часть жизни, обязанность"
            }
        },
        {
            "text": "Как ты реагируешь на боль?",
            "options": {
                "6": "Замираю, не знаю что делать",
                "7": "Иду в неё, проживаю",
                "8": "Избегаю, переключаюсь",
                "9": "Терплю, справляюсь"
            }
        },
        {
            "text": "Что ты чувствуешь в одиночестве?",
            "options": {
                "6": "Страх, тоску",
                "7": "Возможность встретить себя",
                "8": "Дискомфорт, скуку",
                "9": "Спокойствие, если есть дела"
            }
        },
        {
            "text": "Как ты ищешь смысл?",
            "options": {
                "6": "Не знаю как",
                "7": "Через переживания, опыт",
                "8": "Через разные практики",
                "9": "Через работу, служение"
            }
        },
        {
            "text": "Что для тебя глубина?",
            "options": {
                "6": "То, чего я боюсь",
                "7": "То, к чему я стремлюсь",
                "8": "То, что я изучаю",
                "9": "То, что я принимаю"
            }
        },
        {
            "text": "Как ты выражаешь себя?",
            "options": {
                "6": "Никак, молчу",
                "7": "Через искусство, творчество",
                "8": "Через разные образы",
                "9": "Через свою работу"
            }
        },
        {
            "text": "Что ты делаешь с чувствами?",
            "options": {
                "6": "Прячу, боюсь",
                "7": "Исследую, проживаю",
                "8": "Использую для целей",
                "9": "Контролирую, управляю"
            }
        },
        {
            "text": "Как ты работаешь с болью?",
            "options": {
                "6": "Избегаю, убегаю",
                "7": "Иду в неё, трансформирую",
                "8": "Анализирую, изучаю",
                "10": "Помогаю другим с их болью"
            }
        },
        {
            "text": "Что для тебя исцеление?",
            "options": {
                "7": "Встреча с собой",
                "8": "Понимание механизмов",
                "9": "Восстановление функций",
                "10": "Помощь другим"
            }
        },
        {
            "text": "Как ты влияешь на других?",
            "options": {
                "8": "Через эмоции, чувства",
                "9": "Через стабильность, надёжность",
                "10": "Через вдохновение",
                "J": "Через глубину понимания"
            }
        },
        {
            "text": "Что ты даёшь миру?",
            "options": {
                "9": "Стабильность, порядок",
                "10": "Направление, смысл",
                "J": "Глубину, мастерство",
                "Q": "Мудрость, учение"
            }
        },
        {
            "text": "Как ты учишь других чувствовать?",
            "options": {
                "J": "Через свой пример",
                "Q": "Через систему, практики",
                "K": "Через новые методы",
                "A": "Просто живу, не учу"
            }
        },
        {
            "text": "Что для тебя мудрость?",
            "options": {
                "10": "Умение вести других",
                "J": "Глубокое понимание",
                "Q": "Знание, которым делюсь",
                "K": "Создание нового понимания"
            }
        },
        {
            "text": "Какова твоя роль?",
            "options": {
                "J": "Мастер чувств",
                "Q": "Учитель смысла",
                "K": "Создатель новых смыслов",
                "A": "Свободный от смыслов"
            }
        },
        {
            "text": "Что ты оставишь миру?",
            "options": {
                "Q": "Учение о чувствах",
                "K": "Новую парадигму",
                "A": "Пример свободы",
                "10": "Исцелённых людей"
            }
        }
    ],
    
    "SB": [  # БУБНЫ (Ресурсы, достижения, результаты)
        {
            "text": "Что ты чувствуешь в жизни?",
            "options": {
                "6": "Нехватку, недостаток",
                "7": "Борюсь за ресурсы",
                "8": "Ищу возможности",
                "9": "Работаю, зарабатываю"
            }
        },
        {
            "text": "Что ты делаешь, когда мало денег?",
            "options": {
                "6": "Терплю, жду",
                "7": "Ищу способы заработать",
                "8": "Ищу выгодные варианты",
                "9": "Работаю больше"
            }
        },
        {
            "text": "Как ты зарабатываешь?",
            "options": {
                "6": "Как получится, нестабильно",
                "7": "Через усилия, борьбу",
                "8": "Через связи, возможности",
                "9": "Через работу, труд"
            }
        },
        {
            "text": "Что для тебя деньги?",
            "options": {
                "6": "То, чего всегда мало",
                "7": "То, за что надо бороться",
                "8": "Инструмент, возможности",
                "9": "Результат работы"
            }
        },
        {
            "text": "Как ты реагируешь на потери?",
            "options": {
                "6": "Паникую, не знаю что делать",
                "7": "Борюсь, восстанавливаю",
                "8": "Ищу новые возможности",
                "9": "Принимаю, работаю дальше"
            }
        },
        {
            "text": "Что ты чувствуешь без денег?",
            "options": {
                "6": "Страх, беспомощность",
                "7": "Злость, мотивацию",
                "8": "Азарт, вызов",
                "9": "Дискомфорт, но справлюсь"
            }
        },
        {
            "text": "Как ты ищешь ресурсы?",
            "options": {
                "6": "Не знаю как",
                "7": "Активно, настойчиво",
                "8": "Через связи, схемы",
                "9": "Через работу, навыки"
            }
        },
        {
            "text": "Что для тебя успех?",
            "options": {
                "6": "Когда хватает на жизнь",
                "7": "Когда добился своего",
                "8": "Когда выгодно и интересно",
                "9": "Когда стабильно и надёжно"
            }
        },
        {
            "text": "Как ты создаёшь результат?",
            "options": {
                "6": "Сложно, не всегда получается",
                "7": "Через усилия, борьбу",
                "8": "Через стратегию, гибкость",
                "9": "Через систему, дисциплину"
            }
        },
        {
            "text": "Что ты делаешь с ресурсами?",
            "options": {
                "6": "Трачу, не умею копить",
                "7": "Вкладываю в развитие",
                "8": "Использую для новых целей",
                "9": "Распределяю, планирую"
            }
        },
        {
            "text": "Как ты работаешь с деньгами?",
            "options": {
                "6": "Плохо, всегда проблемы",
                "7": "Зарабатываю, но нестабильно",
                "8": "Ищу выгодные схемы",
                "10": "Создаю бизнес, системы"
            }
        },
        {
            "text": "Что для тебя богатство?",
            "options": {
                "7": "Свобода от нужды",
                "8": "Возможности, влияние",
                "9": "Стабильность, безопасность",
                "10": "Результат моего дела"
            }
        },
        {
            "text": "Как ты влияешь на других?",
            "options": {
                "8": "Через выгоду, интерес",
                "9": "Через надёжность, качество",
                "10": "Через результаты, успех",
                "J": "Через мастерство, экспертизу"
            }
        },
        {
            "text": "Что ты даёшь миру?",
            "options": {
                "9": "Качественную работу",
                "10": "Результаты, проекты",
                "J": "Экспертизу, мастерство",
                "Q": "Знания, обучение"
            }
        },
        {
            "text": "Как ты учишь других зарабатывать?",
            "options": {
                "J": "Через свой пример",
                "Q": "Через систему, методы",
                "K": "Через новые подходы",
                "A": "Не учу, каждый сам"
            }
        },
        {
            "text": "Что для тебя мастерство?",
            "options": {
                "10": "Умение создавать результат",
                "J": "Высокий уровень навыков",
                "Q": "Знание, которым делюсь",
                "K": "Создание новых методов"
            }
        },
        {
            "text": "Какова твоя роль?",
            "options": {
                "J": "Мастер своего дела",
                "Q": "Учитель, эксперт",
                "K": "Создатель систем",
                "A": "Свободный от системы"
            }
        },
        {
            "text": "Что ты оставишь миру?",
            "options": {
                "Q": "Систему заработка",
                "K": "Новую экономику",
                "A": "Пример свободы от денег",
                "10": "Успешный бизнес"
            }
        }
    ],
    
    "UB": [  # ПИКИ (Порядок, контроль, системы)
        {
            "text": "Что ты чувствуешь в жизни?",
            "options": {
                "6": "Хаос, непонимание",
                "7": "Борюсь за порядок",
                "8": "Ищу закономерности",
                "9": "Поддерживаю систему"
            }
        },
        {
            "text": "Что ты делаешь, когда хаос?",
            "options": {
                "6": "Теряюсь, не знаю что делать",
                "7": "Пытаюсь навести порядок",
                "8": "Ищу способы адаптироваться",
                "9": "Возвращаюсь к системе"
            }
        },
        {
            "text": "Как ты создаёшь порядок?",
            "options": {
                "6": "Не умею, всё время хаос",
                "7": "Через усилия, борьбу",
                "8": "Через гибкие системы",
                "9": "Через правила, структуру"
            }
        },
        {
            "text": "Что для тебя порядок?",
            "options": {
                "6": "То, чего мне не хватает",
                "7": "То, за что я борюсь",
                "8": "Инструмент для целей",
                "9": "Основа жизни"
            }
        },
        {
            "text": "Как ты реагируешь на хаос?",
            "options": {
                "6": "Паникую, замираю",
                "7": "Злюсь, действую",
                "8": "Ищу возможности",
                "9": "Спокойно восстанавливаю"
            }
        },
        {
            "text": "Что ты чувствуешь без контроля?",
            "options": {
                "6": "Страх, тревогу",
                "7": "Злость, мотивацию",
                "8": "Интерес, вызов",
                "9": "Дискомфорт"
            }
        },
        {
            "text": "Как ты ищешь понимание?",
            "options": {
                "6": "Не знаю как",
                "7": "Активно, настойчиво",
                "8": "Через разные источники",
                "9": "Через систему, обучение"
            }
        },
        {
            "text": "Что для тебя знание?",
            "options": {
                "6": "То, чего мне не хватает",
                "7": "То, что я ищу",
                "8": "Инструмент для целей",
                "9": "Основа работы"
            }
        },
        {
            "text": "Как ты создаёшь системы?",
            "options": {
                "6": "Не умею, всё разваливается",
                "7": "Через усилия, ошибки",
                "8": "Через эксперименты",
                "9": "Через правила, структуру"
            }
        },
        {
            "text": "Что ты делаешь со знаниями?",
            "options": {
                "6": "Не знаю, как применить",
                "7": "Использую для борьбы",
                "8": "Использую для целей",
                "9": "Систематизирую, применяю"
            }
        },
        {
            "text": "Как ты работаешь с информацией?",
            "options": {
                "6": "Теряюсь, не понимаю",
                "7": "Ищу нужное, отбрасываю лишнее",
                "8": "Ищу выгодное, полезное",
                "10": "Создаю системы знаний"
            }
        },
        {
            "text": "Что для тебя мудрость?",
            "options": {
                "7": "Понимание, как действовать",
                "8": "Знание, как достигать целей",
                "9": "Знание системы",
                "10": "Создание системы"
            }
        },
        {
            "text": "Как ты влияешь на других?",
            "options": {
                "8": "Через логику, аргументы",
                "9": "Через правила, структуру",
                "10": "Через системы, организацию",
                "J": "Через экспертизу, мастерство"
            }
        },
        {
            "text": "Что ты даёшь миру?",
            "options": {
                "9": "Порядок, стабильность",
                "10": "Системы, организацию",
                "J": "Экспертизу, мастерство",
                "Q": "Знания, обучение"
            }
        },
        {
            "text": "Как ты учишь других понимать?",
            "options": {
                "J": "Через свой пример",
                "Q": "Через систему, методы",
                "K": "Через новые подходы",
                "A": "Не учу, каждый сам"
            }
        },
        {
            "text": "Что для тебя мастерство?",
            "options": {
                "10": "Умение создавать порядок",
                "J": "Глубокое понимание",
                "Q": "Знание, которым делюсь",
                "K": "Создание новых систем"
            }
        },
        {
            "text": "Какова твоя роль?",
            "options": {
                "J": "Мастер своего дела",
                "Q": "Учитель, эксперт",
                "K": "Создатель систем",
                "A": "Свободный от систем"
            }
        },
        {
            "text": "Что ты оставишь миру?",
            "options": {
                "Q": "Систему знаний",
                "K": "Новую парадигму",
                "A": "Пример свободы",
                "10": "Организацию, структуру"
            }
        }
    ]
}

# ========== ЭТАП 3: ОПРЕДЕЛЕНИЕ ПРОБЛЕМНОГО УРОВНЯ (12 вопросов) ==========
# Вопросы РАЗНЫЕ для каждой масти!

STAGE_3_QUESTIONS = {
    "TF": [  # ТРЕФЫ
        # ОКРУЖЕНИЕ (2 вопроса)
        {
            "level": "OKRUZHENIE",
            "text": "Где вы чувствуете себя хуже всего?",
            "options": {
                "PROBLEM": "Среди чужих людей",
                "PROBLEM_ALT": "В одиночестве",
                "OK": "Везде нормально"
            }
        },
        {
            "level": "OKRUZHENIE",
            "text": "Что в вашем окружении не так?",
            "options": {
                "PROBLEM": "Не те люди",
                "PROBLEM_ALT": "Нет моих людей",
                "OK": "Всё нормально"
            }
        },
        # ПОВЕДЕНИЕ (2 вопроса)
        {
            "level": "POVEDENIE",
            "text": "Что вы делаете, когда хотите сблизиться?",
            "options": {
                "PROBLEM": "Не знаю как",
                "PROBLEM_ALT": "Делаю, но не работает",
                "OK": "Умею хорошо"
            }
        },
        {
            "level": "POVEDENIE",
            "text": "Как вы строите отношения?",
            "options": {
                "PROBLEM": "Неправильно",
                "PROBLEM_ALT": "Не умею",
                "OK": "Хорошо"
            }
        },
        # СПОСОБНОСТИ (2 вопроса)
        {
            "level": "SPOSOBNOSTI",
            "text": "Вы умеете налаживать связи?",
            "options": {
                "PROBLEM": "Нет этого навыка",
                "PROBLEM_ALT": "Плохо получается",
                "OK": "Да, умею"
            }
        },
        {
            "level": "SPOSOBNOSTI",
            "text": "Что вам мешает быть ближе с людьми?",
            "options": {
                "PROBLEM": "Не умею чувствовать других",
                "PROBLEM_ALT": "Не умею открываться",
                "OK": "Ничего не мешает"
            }
        },
        # ЦЕННОСТИ (2 вопроса)
        {
            "level": "CENNOSTI",
            "text": "Зачем вам связи с людьми?",
            "options": {
                "PROBLEM": "Не знаю зачем",
                "PROBLEM_ALT": "Не понимаю смысла",
                "OK": "Знаю зачем"
            }
        },
        {
            "level": "CENNOSTI",
            "text": "Что для вас важно в отношениях?",
            "options": {
                "PROBLEM": "Не понимаю что",
                "PROBLEM_ALT": "Запутался в ценностях",
                "OK": "Понимаю"
            }
        },
        # ИДЕНТИЧНОСТЬ (2 вопроса)
        {
            "level": "IDENTICHNOST",
            "text": "Кто вы в отношениях?",
            "options": {
                "PROBLEM": "Не знаю кто",
                "PROBLEM_ALT": "Играю роль",
                "OK": "Знаю кто я"
            }
        },
        {
            "level": "IDENTICHNOST",
            "text": "Вы чувствуете себя собой с людьми?",
            "options": {
                "PROBLEM": "Нет, я другой",
                "PROBLEM_ALT": "Не понимаю, кто я",
                "OK": "Да, я — это я"
            }
        },
        # МИССИЯ (2 вопроса)
        {
            "level": "MISSIYA",
            "text": "Для чего вы нужны людям?",
            "options": {
                "PROBLEM": "Не знаю для чего",
                "PROBLEM_ALT": "Не вижу смысла",
                "OK": "Знаю свою роль"
            }
        },
        {
            "level": "MISSIYA",
            "text": "Какой ваш вклад в мир через связи?",
            "options": {
                "PROBLEM": "Нет вклада",
                "PROBLEM_ALT": "Не понимаю зачем я",
                "OK": "Понимаю миссию"
            }
        }
    ],
    
    "CV": [  # ЧЕРВИ
        # ОКРУЖЕНИЕ
        {
            "level": "OKRUZHENIE",
            "text": "Где вы чувствуете пустоту сильнее?",
            "options": {
                "PROBLEM": "В поверхностном мире",
                "PROBLEM_ALT": "В одиночестве",
                "OK": "Нигде особенно"
            }
        },
        {
            "level": "OKRUZHENIE",
            "text": "Что не так с вашим миром?",
            "options": {
                "PROBLEM": "Вокруг нет глубины",
                "PROBLEM_ALT": "Нет смысла вокруг",
                "OK": "Всё нормально"
            }
        },
        # ПОВЕДЕНИЕ
        {
            "level": "POVEDENIE",
            "text": "Что вы делаете, когда ищете смысл?",
            "options": {
                "PROBLEM": "Не знаю как искать",
                "PROBLEM_ALT": "Ищу, но не нахожу",
                "OK": "Умею искать"
            }
        },
        {
            "level": "POVEDENIE",
            "text": "Как вы работаете с чувствами?",
            "options": {
                "PROBLEM": "Неправильно",
                "PROBLEM_ALT": "Не умею",
                "OK": "Хорошо"
            }
        },
        # СПОСОБНОСТИ
        {
            "level": "SPOSOBNOSTI",
            "text": "Вы умеете чувствовать глубоко?",
            "options": {
                "PROBLEM": "Нет этого навыка",
                "PROBLEM_ALT": "Плохо получается",
                "OK": "Да, умею"
            }
        },
        {
            "level": "SPOSOBNOSTI",
            "text": "Что мешает вам чувствовать?",
            "options": {
                "PROBLEM": "Не умею проживать",
                "PROBLEM_ALT": "Не умею быть в чувстве",
                "OK": "Ничего не мешает"
            }
        },
        # ЦЕННОСТИ
        {
            "level": "CENNOSTI",
            "text": "Зачем вам глубина и смысл?",
            "options": {
                "PROBLEM": "Не знаю зачем",
                "PROBLEM_ALT": "Не понимаю смысла",
                "OK": "Знаю зачем"
            }
        },
        {
            "level": "CENNOSTI",
            "text": "Что для вас важно в жизни?",
            "options": {
                "PROBLEM": "Не понимаю что",
                "PROBLEM_ALT": "Запутался в ценностях",
                "OK": "Понимаю"
            }
        },
        # ИДЕНТИЧНОСТЬ
        {
            "level": "IDENTICHNOST",
            "text": "Кто вы на самом деле?",
            "options": {
                "PROBLEM": "Не знаю кто",
                "PROBLEM_ALT": "Потерял себя",
                "OK": "Знаю кто я"
            }
        },
        {
            "level": "IDENTICHNOST",
            "text": "Вы чувствуете свою суть?",
            "options": {
                "PROBLEM": "Нет, я пустой",
                "PROBLEM_ALT": "Не понимаю, кто я",
                "OK": "Да, чувствую"
            }
        },
        # МИССИЯ
        {
            "level": "MISSIYA",
            "text": "Для чего вы в этом мире?",
            "options": {
                "PROBLEM": "Не знаю для чего",
                "PROBLEM_ALT": "Не вижу смысла",
                "OK": "Знаю свою миссию"
            }
        },
        {
            "level": "MISSIYA",
            "text": "Какой ваш вклад в мир через чувства?",
            "options": {
                "PROBLEM": "Нет вклада",
                "PROBLEM_ALT": "Не понимаю зачем я",
                "OK": "Понимаю миссию"
            }
        }
    ],
    
    "SB": [  # БУБНЫ
        # ОКРУЖЕНИЕ
        {
            "level": "OKRUZHENIE",
            "text": "Где вы чувствуете нехватку сильнее?",
            "options": {
                "PROBLEM": "В бедном окружении",
                "PROBLEM_ALT": "Везде не хватает",
                "OK": "Нигде особенно"
            }
        },
        {
            "level": "OKRUZHENIE",
            "text": "Что не так с вашим миром?",
            "options": {
                "PROBLEM": "Мало ресурсов вокруг",
                "PROBLEM_ALT": "Нет возможностей",
                "OK": "Всё нормально"
            }
        },
        # ПОВЕДЕНИЕ
        {
            "level": "POVEDENIE",
            "text": "Что вы делаете, когда нужны ресурсы?",
            "options": {
                "PROBLEM": "Не знаю как добыть",
                "PROBLEM_ALT": "Делаю, но не получается",
                "OK": "Умею добывать"
            }
        },
        {
            "level": "POVEDENIE",
            "text": "Как вы достигаете целей?",
            "options": {
                "PROBLEM": "Неправильно",
                "PROBLEM_ALT": "Не умею",
                "OK": "Хорошо"
            }
        },
        # СПОСОБНОСТИ
        {
            "level": "SPOSOBNOSTI",
            "text": "Вы умеете зарабатывать/создавать?",
            "options": {
                "PROBLEM": "Нет этого навыка",
                "PROBLEM_ALT": "Плохо получается",
                "OK": "Да, умею"
            }
        },
        {
            "level": "SPOSOBNOSTI",
            "text": "Что мешает вам достигать?",
            "options": {
                "PROBLEM": "Не умею планировать",
                "PROBLEM_ALT": "Не умею действовать",
                "OK": "Ничего не мешает"
            }
        },
        # ЦЕННОСТИ
        {
            "level": "CENNOSTI",
            "text": "Зачем вам достижения?",
            "options": {
                "PROBLEM": "Не знаю зачем",
                "PROBLEM_ALT": "Не понимаю смысла",
                "OK": "Знаю зачем"
            }
        },
        {
            "level": "CENNOSTI",
            "text": "Что для вас важно в успехе?",
            "options": {
                "PROBLEM": "Не понимаю что",
                "PROBLEM_ALT": "Запутался в ценностях",
                "OK": "Понимаю"
            }
        },
        # ИДЕНТИЧНОСТЬ
        {
            "level": "IDENTICHNOST",
            "text": "Кто вы в мире достижений?",
            "options": {
                "PROBLEM": "Не знаю кто",
                "PROBLEM_ALT": "Неудачник",
                "OK": "Знаю кто я"
            }
        },
        {
            "level": "IDENTICHNOST",
            "text": "Вы чувствуете себя способным?",
            "options": {
                "PROBLEM": "Нет, я слабый",
                "PROBLEM_ALT": "Не понимаю, кто я",
                "OK": "Да, я способен"
            }
        },
        # МИССИЯ
        {
            "level": "MISSIYA",
            "text": "Для чего вы создаёте?",
            "options": {
                "PROBLEM": "Не знаю для чего",
                "PROBLEM_ALT": "Не вижу смысла",
                "OK": "Знаю свою миссию"
            }
        },
        {
            "level": "MISSIYA",
            "text": "Какой ваш вклад в мир через дела?",
            "options": {
                "PROBLEM": "Нет вклада",
                "PROBLEM_ALT": "Не понимаю зачем я",
                "OK": "Понимаю миссию"
            }
        }
    ],
    
    "UB": [  # ПИКИ
        # ОКРУЖЕНИЕ
        {
            "level": "OKRUZHENIE",
            "text": "Где вы чувствуете хаос сильнее?",
            "options": {
                "PROBLEM": "В беспорядочном мире",
                "PROBLEM_ALT": "Везде хаос",
                "OK": "Нигде особенно"
            }
        },
        {
            "level": "OKRUZHENIE",
            "text": "Что не так с вашим миром?",
            "options": {
                "PROBLEM": "Вокруг нет порядка",
                "PROBLEM_ALT": "Нет логики",
                "OK": "Всё нормально"
            }
        },
        # ПОВЕДЕНИЕ
        {
            "level": "POVEDENIE",
            "text": "Что вы делаете, когда нужен порядок?",
            "options": {
                "PROBLEM": "Не знаю как создать",
                "PROBLEM_ALT": "Делаю, но не получается",
                "OK": "Умею создавать"
            }
        },
        {
            "level": "POVEDENIE",
            "text": "Как вы наводите порядок?",
            "options": {
                "PROBLEM": "Неправильно",
                "PROBLEM_ALT": "Не умею",
                "OK": "Хорошо"
            }
        },
        # СПОСОБНОСТИ
        {
            "level": "SPOSOBNOSTI",
            "text": "Вы умеете создавать системы?",
            "options": {
                "PROBLEM": "Нет этого навыка",
                "PROBLEM_ALT": "Плохо получается",
                "OK": "Да, умею"
            }
        },
        {
            "level": "SPOSOBNOSTI",
            "text": "Что мешает вам контролировать?",
            "options": {
                "PROBLEM": "Не умею анализировать",
                "PROBLEM_ALT": "Не умею структурировать",
                "OK": "Ничего не мешает"
            }
        },
        # ЦЕННОСТИ
        {
            "level": "CENNOSTI",
            "text": "Зачем вам порядок?",
            "options": {
                "PROBLEM": "Не знаю зачем",
                "PROBLEM_ALT": "Не понимаю смысла",
                "OK": "Знаю зачем"
            }
        },
        {
            "level": "CENNOSTI",
            "text": "Что для вас важно в системах?",
            "options": {
                "PROBLEM": "Не понимаю что",
                "PROBLEM_ALT": "Запутался в ценностях",
                "OK": "Понимаю"
            }
        },
        # ИДЕНТИЧНОСТЬ
        {
            "level": "IDENTICHNOST",
            "text": "Кто вы в мире систем?",
            "options": {
                "PROBLEM": "Не знаю кто",
                "PROBLEM_ALT": "Хаотичный",
                "OK": "Знаю кто я"
            }
        },
        {
            "level": "IDENTICHNOST",
            "text": "Вы чувствуете себя упорядоченным?",
            "options": {
                "PROBLEM": "Нет, я хаос",
                "PROBLEM_ALT": "Не понимаю, кто я",
                "OK": "Да, я структурен"
            }
        },
        # МИССИЯ
        {
            "level": "MISSIYA",
            "text": "Для чего вы создаёте порядок?",
            "options": {
                "PROBLEM": "Не знаю для чего",
                "PROBLEM_ALT": "Не вижу смысла",
                "OK": "Знаю свою миссию"
            }
        },
        {
            "level": "MISSIYA",
            "text": "Какой ваш вклад в мир через системы?",
            "options": {
                "PROBLEM": "Нет вклада",
                "PROBLEM_ALT": "Не понимаю зачем я",
                "OK": "Понимаю миссию"
            }
        }
    ]
}

# ========== ТАБЛИЦА НАЧИСЛЕНИЯ БАЛЛОВ ДЛЯ ЭТАПА 2 ==========
STAGE_2_SCORING = {
    "TF": {
        0: {"6": 2, "7": 2, "8": 2, "9": 2},
        1: {"6": 2, "7": 2, "8": 2, "9": 2},
        2: {"6": 2, "7": 2, "8": 2, "9": 2},
        3: {"6": 2, "7": 2, "8": 2, "9": 2},
        4: {"6": 2, "7": 2, "8": 2, "9": 2},
        5: {"6": 2, "7": 2, "8": 2, "9": 2},
        6: {"6": 2, "7": 2, "8": 2, "9": 2},
        7: {"6": 2, "7": 2, "8": 2, "9": 2},
        8: {"6": 2, "7": 2, "8": 2, "9": 2},
        9: {"6": 2, "7": 2, "8": 2, "9": 2},
        10: {"6": 1, "7": 1, "8": 1, "10": 2},
        11: {"7": 1, "8": 1, "9": 1, "10": 2},
        12: {"8": 2, "9": 2, "10": 2, "J": 2},
        13: {"9": 2, "10": 2, "J": 2, "Q": 2},
        14: {"J": 2, "Q": 2, "K": 2, "A": 2},
        15: {"10": 2, "J": 2, "Q": 2, "K": 2},
        16: {"J": 2, "Q": 2, "K": 2, "A": 2},
        17: {"Q": 2, "K": 2, "A": 2, "10": 2}
    },
    "CV": {
        0: {"6": 2, "7": 2, "8": 2, "9": 2},
        1: {"6": 2, "7": 2, "8": 2, "9": 2},
        2: {"6": 2, "7": 2, "8": 2, "9": 2},
        3: {"6": 2, "7": 2, "8": 2, "9": 2},
        4: {"6": 2, "7": 2, "8": 2, "9": 2},
        5: {"6": 2, "7": 2, "8": 2, "9": 2},
        6: {"6": 2, "7": 2, "8": 2, "9": 2},
        7: {"6": 2, "7": 2, "8": 2, "9": 2},
        8: {"6": 2, "7": 2, "8": 2, "9": 2},
        9: {"6": 2, "7": 2, "8": 2, "9": 2},
        10: {"6": 1, "7": 1, "8": 1, "10": 2},
        11: {"7": 1, "8": 1, "9": 1, "10": 2},
        12: {"8": 2, "9": 2, "10": 2, "J": 2},
        13: {"9": 2, "10": 2, "J": 2, "Q": 2},
        14: {"J": 2, "Q": 2, "K": 2, "A": 2},
        15: {"10": 2, "J": 2, "Q": 2, "K": 2},
        16: {"J": 2, "Q": 2, "K": 2, "A": 2},
        17: {"Q": 2, "K": 2, "A": 2, "10": 2}
    },
    "SB": {
        0: {"6": 2, "7": 2, "8": 2, "9": 2},
        1: {"6": 2, "7": 2, "8": 2, "9": 2},
        2: {"6": 2, "7": 2, "8": 2, "9": 2},
        3: {"6": 2, "7": 2, "8": 2, "9": 2},
        4: {"6": 2, "7": 2, "8": 2, "9": 2},
        5: {"6": 2, "7": 2, "8": 2, "9": 2},
        6: {"6": 2, "7": 2, "8": 2, "9": 2},
        7: {"6": 2, "7": 2, "8": 2, "9": 2},
        8: {"6": 2, "7": 2, "8": 2, "9": 2},
        9: {"6": 2, "7": 2, "8": 2, "9": 2},
        10: {"6": 1, "7": 1, "8": 1, "10": 2},
        11: {"7": 1, "8": 1, "9": 1, "10": 2},
        12: {"8": 2, "9": 2, "10": 2, "J": 2},
        13: {"9": 2, "10": 2, "J": 2, "Q": 2},
        14: {"J": 2, "Q": 2, "K": 2, "A": 2},
        15: {"10": 2, "J": 2, "Q": 2, "K": 2},
        16: {"J": 2, "Q": 2, "K": 2, "A": 2},
        17: {"Q": 2, "K": 2, "A": 2, "10": 2}
    },
    "UB": {
        0: {"6": 2, "7": 2, "8": 2, "9": 2},
        1: {"6": 2, "7": 2, "8": 2, "9": 2},
        2: {"6": 2, "7": 2, "8": 2, "9": 2},
        3: {"6": 2, "7": 2, "8": 2, "9": 2},
        4: {"6": 2, "7": 2, "8": 2, "9": 2},
        5: {"6": 2, "7": 2, "8": 2, "9": 2},
        6: {"6": 2, "7": 2, "8": 2, "9": 2},
        7: {"6": 2, "7": 2, "8": 2, "9": 2},
        8: {"6": 2, "7": 2, "8": 2, "9": 2},
        9: {"6": 2, "7": 2, "8": 2, "9": 2},
        10: {"6": 1, "7": 1, "8": 1, "10": 2},
        11: {"7": 1, "8": 1, "9": 1, "10": 2},
        12: {"8": 2, "9": 2, "10": 2, "J": 2},
        13: {"9": 2, "10": 2, "J": 2, "Q": 2},
        14: {"J": 2, "Q": 2, "K": 2, "A": 2},
        15: {"10": 2, "J": 2, "Q": 2, "K": 2},
        16: {"J": 2, "Q": 2, "K": 2, "A": 2},
        17: {"Q": 2, "K": 2, "A": 2, "10": 2}
    }
}

# ========== ФУНКЦИИ ==========
def calculate_progress(current: int, total: int) -> str:
    """Вычисляет прогресс"""
    progress = int((current / total) * 100)
    filled = int(progress / 10)
    bar = "▓" * filled + "░" * (10 - filled)
    return f"{bar} {progress}%\nПройдено: {current} из {total}"

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Команда /start"""
    user = update.effective_user
    welcome_text = (
        f"Привет, {user.first_name}! 👋\n\n"
        f"🎯 Добро пожаловать в НОВЫЙ ТЕСТ!\n\n"
        f"📊 Что тебя ждёт:\n\n"
        f"1️⃣ ЭТАП 1: Определение масти (16 вопросов)\n"
        f"→ Узнаешь свою базовую программу\n\n"
        f"2️⃣ ЭТАП 2: Определение карты (18 вопросов)\n"
        f"→ Найдём твою текущую карту\n\n"
        f"3️⃣ ЭТАП 3: Проблемный уровень (12 вопросов)\n"
        f"→ Определим, на каком уровне проблема\n\n"
        f"⏱ Займёт 15-20 минут\n"
        f"📌 Отвечай честно!\n\n"
        f"Готов начать?"
    )
    keyboard = [[InlineKeyboardButton("🚀 Начать тест", callback_data="start_test")]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await update.message.reply_text(welcome_text, reply_markup=reply_markup)

async def start_test(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Начало теста"""
    query = update.callback_query
    await query.answer()
    
    # Инициализация
    context.user_data["stage_1_scores"] = {
        "VOVNE": 0,
        "VNUTR": 0,
        "UMOZ": 0,
        "FAKT": 0
    }
    context.user_data["stage_2_scores"] = {
        "6": 0, "7": 0, "8": 0, "9": 0, "10": 0,
        "J": 0, "Q": 0, "K": 0, "A": 0
    }
    context.user_data["stage_3_scores"] = {
        "OKRUZHENIE": 0,
        "POVEDENIE": 0,
        "SPOSOBNOSTI": 0,
        "CENNOSTI": 0,
        "IDENTICHNOST": 0,
        "MISSIYA": 0
    }
    context.user_data["current_question"] = 0
    
    intro_text = (
        f"🎯 ЭТАП 1: ОПРЕДЕЛЕНИЕ МАСТИ\n\n"
        f"Сейчас я задам 16 вопросов, чтобы определить твою базовую программу.\n\n"
        f"Готов?"
    )
    keyboard = [[InlineKeyboardButton("▶️ Начать", callback_data="start_stage_1")]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text(intro_text, reply_markup=reply_markup)

async def start_stage_1(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Начало ЭТАПА 1"""
    query = update.callback_query
    await query.answer()
    return await ask_stage_1_question(update, context)

async def ask_stage_1_question(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Задаёт вопрос ЭТАПА 1"""
    if update.callback_query:
        query = update.callback_query
        await query.answer()
    else:
        query = None
    
    current_q = context.user_data["current_question"]
    question = STAGE_1_QUESTIONS[current_q]
    progress = calculate_progress(current_q, 16)
    
    question_text = (
        f"🎯 ЭТАП 1: ОПРЕДЕЛЕНИЕ МАСТИ\n"
        f"Вопрос {current_q + 1}/16\n\n"
        f"<b>{question['text']}</b>\n\n"
        f"{progress}"
    )
    
    keyboard = []
    for key, answer in question["options"].items():
        keyboard.append([InlineKeyboardButton(answer, callback_data=f"s1_{key}")])
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    if query:
        await query.edit_message_text(question_text, reply_markup=reply_markup, parse_mode="HTML")
    else:
        await update.message.reply_text(question_text, reply_markup=reply_markup, parse_mode="HTML")
    
    return STAGE_1

async def handle_stage_1_answer(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Обработка ответа ЭТАПА 1"""
    query = update.callback_query
    await query.answer()
    
    answer = query.data.split("_")[1]
    
    # Начисляем баллы
    if answer in ["VOVNE", "VNUTR", "UMOZ", "FAKT"]:
        context.user_data["stage_1_scores"][answer] += 1
    
    context.user_data["current_question"] += 1
    current_q = context.user_data["current_question"]
    
    if current_q >= 16:
        return await finish_stage_1(update, context)
    
    return await ask_stage_1_question(update, context)

async def finish_stage_1(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Завершение ЭТАПА 1"""
    query = update.callback_query
    scores = context.user_data["stage_1_scores"]
    
    # Определяем масть
    axisX = "VOVNE" if scores["VOVNE"] > scores["VNUTR"] else "VNUTR"
    axisY = "UMOZ" if scores["UMOZ"] > scores["FAKT"] else "FAKT"
    
    if axisX == "VOVNE" and axisY == "UMOZ":
        suit = "TF"
        suit_name = "♥️ ТРЕФЫ (Связи)"
    elif axisX == "VNUTR" and axisY == "UMOZ":
        suit = "CV"
        suit_name = "♦️ ЧЕРВИ (Смысл)"
    elif axisX == "VOVNE" and axisY == "FAKT":
        suit = "SB"
        suit_name = "♦️ БУБНЫ (Ресурсы)"
    else:
        suit = "UB"
        suit_name = "♠️ ПИКИ (Порядок)"
    
    context.user_data["suit"] = suit
    context.user_data["current_question"] = 0
    
    result_text = (
        f"✅ ЭТАП 1 ЗАВЕРШЁН!\n\n"
        f"🎯 Твоя масть:\n"
        f"<b>{suit_name}</b>\n\n"
        f"📊 Результаты:\n"
        f"Фокус ВОВНЕ: {scores['VOVNE']}\n"
        f"Фокус ВНУТРЬ: {scores['VNUTR']}\n"
        f"Страх УМОЗРИТЕЛЬНОГО: {scores['UMOZ']}\n"
        f"Страх ФАКТИЧЕСКОГО: {scores['FAKT']}\n\n"
        f"🎯 ЭТАП 2: ОПРЕДЕЛЕНИЕ КАРТЫ\n"
        f"Теперь определим твою карту внутри этой масти.\n\n"
        f"Готов продолжить?"
    )
    keyboard = [[InlineKeyboardButton("▶️ Начать ЭТАП 2", callback_data="start_stage_2")]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text(result_text, reply_markup=reply_markup, parse_mode="HTML")
    return STAGE_2

async def start_stage_2(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Начало ЭТАПА 2"""
    query = update.callback_query
    await query.answer()
    return await ask_stage_2_question(update, context)

async def ask_stage_2_question(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Задаёт вопрос ЭТАПА 2"""
    if update.callback_query:
        query = update.callback_query
        await query.answer()
    else:
        query = None
    
    suit = context.user_data["suit"]
    current_q = context.user_data["current_question"]
    question = STAGE_2_QUESTIONS[suit][current_q]
    progress = calculate_progress(current_q, 18)
    
    question_text = (
        f"🎯 ЭТАП 2: ОПРЕДЕЛЕНИЕ КАРТЫ\n"
        f"Вопрос {current_q + 1}/18\n\n"
        f"<b>{question['text']}</b>\n\n"
        f"{progress}"
    )
    
    keyboard = []
    for card, answer in question["options"].items():
        keyboard.append([InlineKeyboardButton(answer, callback_data=f"s2_{card}")])
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    if query:
        await query.edit_message_text(question_text, reply_markup=reply_markup, parse_mode="HTML")
    else:
        await update.message.reply_text(question_text, reply_markup=reply_markup, parse_mode="HTML")
    
    return STAGE_2

async def handle_stage_2_answer(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Обработка ответа ЭТАПА 2"""
    query = update.callback_query
    await query.answer()
    
    card = query.data.split("_")[1]
    suit = context.user_data["suit"]
    current_q = context.user_data["current_question"]
    
    # Начисляем баллы по таблице
    scoring = STAGE_2_SCORING[suit][current_q]
    if card in scoring:
        context.user_data["stage_2_scores"][card] += scoring[card]
    
    context.user_data["current_question"] += 1
    current_q = context.user_data["current_question"]
    
    if current_q >= 18:
        return await finish_stage_2(update, context)
    
    return await ask_stage_2_question(update, context)

async def finish_stage_2(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Завершение ЭТАПА 2"""
    query = update.callback_query
    scores = context.user_data["stage_2_scores"]
    
    # Определяем карту с максимальным баллом
    card = max(scores, key=scores.get)
    context.user_data["card"] = card
    context.user_data["current_question"] = 0
    
    result_text = (
        f"✅ ЭТАП 2 ЗАВЕРШЁН!\n\n"
        f"🎯 Твоя карта:\n"
        f"<b>{card}</b>\n\n"
        f"📊 Результаты:\n"
    )
    for c, score in scores.items():
        result_text += f"{c}: {score}\n"
    
    result_text += (
        f"\n🎯 ЭТАП 3: ПРОБЛЕМНЫЙ УРОВЕНЬ\n"
        f"Теперь определим, на каком уровне у тебя проблема.\n\n"
        f"Готов продолжить?"
    )
    keyboard = [[InlineKeyboardButton("▶️ Начать ЭТАП 3", callback_data="start_stage_3")]]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text(result_text, reply_markup=reply_markup, parse_mode="HTML")
    return STAGE_3

async def start_stage_3(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Начало ЭТАПА 3"""
    query = update.callback_query
    await query.answer()
    return await ask_stage_3_question(update, context)

async def ask_stage_3_question(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Задаёт вопрос ЭТАПА 3"""
    if update.callback_query:
        query = update.callback_query
        await query.answer()
    else:
        query = None
    
    suit = context.user_data["suit"]
    current_q = context.user_data["current_question"]
    question = STAGE_3_QUESTIONS[suit][current_q]
    progress = calculate_progress(current_q, 12)
    
    question_text = (
        f"🎯 ЭТАП 3: ПРОБЛЕМНЫЙ УРОВЕНЬ\n"
        f"Вопрос {current_q + 1}/12\n\n"
        f"<b>{question['text']}</b>\n\n"
        f"{progress}"
    )
    
    keyboard = []
    for key, answer in question["options"].items():
        keyboard.append([InlineKeyboardButton(answer, callback_data=f"s3_{key}")])
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    if query:
        await query.edit_message_text(question_text, reply_markup=reply_markup, parse_mode="HTML")
    else:
        await update.message.reply_text(question_text, reply_markup=reply_markup, parse_mode="HTML")
    
    return STAGE_3

async def handle_stage_3_answer(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Обработка ответа ЭТАПА 3"""
    query = update.callback_query
    await query.answer()
    
    answer = query.data.split("_")[1]
    suit = context.user_data["suit"]
    current_q = context.user_data["current_question"]
    question = STAGE_3_QUESTIONS[suit][current_q]
    
    # Начисляем баллы
    if answer in ["PROBLEM", "PROBLEM_ALT"]:
        level = question["level"]
        context.user_data["stage_3_scores"][level] += 2
    
    context.user_data["current_question"] += 1
    current_q = context.user_data["current_question"]
    
    if current_q >= 12:
        return await show_result(update, context)
    
    return await ask_stage_3_question(update, context)

async def show_result(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Показ результата"""
    query = update.callback_query
    
    suit = context.user_data["suit"]
    card = context.user_data["card"]
    scores = context.user_data["stage_3_scores"]
    
    # Определяем проблемный уровень
    problem_level = max(scores, key=scores.get)
    
    level_names = {
        "OKRUZHENIE": "🌍 ОКРУЖЕНИЕ",
        "POVEDENIE": "🏃 ПОВЕДЕНИЕ",
        "SPOSOBNOSTI": "💪 СПОСОБНОСТИ",
        "CENNOSTI": "🧠 ЦЕННОСТИ",
        "IDENTICHNOST": "👤 ИДЕНТИЧНОСТЬ",
        "MISSIYA": "🎯 МИССИЯ"
    }
    
    result_text = (
        f"🎉 ТЕСТ ЗАВЕРШЁН!\n\n"
        f"🎴 Твой результат:\n"
        f"Масть: <b>{suit}</b>\n"
        f"Карта: <b>{card}</b>\n"
        f"Проблемный уровень: <b>{level_names[problem_level]}</b>\n\n"
        f"📊 Баллы по уровням:\n"
    )
    for level, score in scores.items():
        result_text += f"{level_names[level]}: {score}\n"
    
    result_text += (
        f"\n💡 Это твой текущий профиль!\n"
        f"Хочешь узнать больше?\n"
        f"👉 @meysternlp"
    )
    
    keyboard = [
        [InlineKeyboardButton("🔄 Пройти заново", callback_data="start_test")],
        [InlineKeyboardButton("💬 Написать автору", url="https://t.me/meysternlp")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    await query.edit_message_text(result_text, reply_markup=reply_markup, parse_mode="HTML")
    return ConversationHandler.END

async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Отмена теста"""
    await update.message.reply_text("❌ Тест отменён. /start для начала заново.")
    return ConversationHandler.END

def main():
    """Запуск бота"""
    application = Application.builder().token(TELEGRAM_BOT_TOKEN).build()
    
    conv_handler = ConversationHandler(
        entry_points=[
            CommandHandler("start", start),
            CallbackQueryHandler(start_test, pattern="^start_test$")
        ],
        states={
            STAGE_1: [
                CallbackQueryHandler(start_stage_1, pattern="^start_stage_1$"),
                CallbackQueryHandler(handle_stage_1_answer, pattern="^s1_")
            ],
            STAGE_2: [
                CallbackQueryHandler(start_stage_2, pattern="^start_stage_2$"),
                CallbackQueryHandler(handle_stage_2_answer, pattern="^s2_")
            ],
            STAGE_3: [
                CallbackQueryHandler(start_stage_3, pattern="^start_stage_3$"),
                CallbackQueryHandler(handle_stage_3_answer, pattern="^s3_")
            ]
        },
        fallbacks=[CommandHandler("cancel", cancel)]
    )
    
    application.add_handler(conv_handler)
    logger.info("✅ Бот запущен!")
    application.run_polling()

if __name__ == "__main__":
    main()
